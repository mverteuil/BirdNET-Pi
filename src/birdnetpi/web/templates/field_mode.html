<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ site_name }} - {{ _('Field Mode') }}</title>
    <link rel="stylesheet" href="/static/style.css" />
    <style>
      /* High contrast, mobile-first field mode styles */
      :root {
        --field-primary: #000000;
        --field-secondary: #ffffff;
        --field-success: #00ff00;
        --field-warning: #ffaa00;
        --field-danger: #ff0000;
        --field-info: #0088ff;
        --field-bg: #ffffff;
        --field-text: #000000;
        --field-border: #666666;
      }

      /* Dark mode for outdoor use */
      @media (prefers-color-scheme: dark) {
        :root {
          --field-primary: #ffffff;
          --field-secondary: #000000;
          --field-success: #00cc00;
          --field-warning: #ff8800;
          --field-danger: #cc0000;
          --field-info: #0066cc;
          --field-bg: #000000;
          --field-text: #ffffff;
          --field-border: #999999;
        }
      }

      body {
        background-color: var(--field-bg);
        color: var(--field-text);
        font-family: Arial, sans-serif;
        font-size: 18px;
        line-height: 1.4;
        margin: 0;
        padding: 10px;
      }

      .field-container {
        max-width: 600px;
        margin: 0 auto;
      }

      .status-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 20px;
      }

      .status-card {
        border: 2px solid var(--field-border);
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        font-weight: bold;
        min-height: 80px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .status-healthy {
        border-color: var(--field-success);
        background-color: rgba(0, 255, 0, 0.1);
      }

      .status-warning {
        border-color: var(--field-warning);
        background-color: rgba(255, 170, 0, 0.1);
      }

      .status-critical {
        border-color: var(--field-danger);
        background-color: rgba(255, 0, 0, 0.1);
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
        100% {
          opacity: 1;
        }
      }

      .gps-info {
        border: 2px solid var(--field-info);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        background-color: rgba(0, 136, 255, 0.1);
      }

      .recent-detections {
        border: 2px solid var(--field-border);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
      }

      .detection-item {
        border-bottom: 1px solid var(--field-border);
        padding: 10px 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .detection-item:last-child {
        border-bottom: none;
      }

      .detection-species {
        font-weight: bold;
        font-size: 16px;
      }

      .detection-confidence {
        color: var(--field-success);
        font-size: 14px;
      }

      .detection-time {
        color: var(--field-text);
        opacity: 0.7;
        font-size: 14px;
      }

      .control-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 20px;
      }

      .field-button {
        padding: 15px;
        border: 2px solid var(--field-border);
        border-radius: 8px;
        background-color: var(--field-bg);
        color: var(--field-text);
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        text-align: center;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 50px;
      }

      .field-button:hover,
      .field-button:focus {
        background-color: var(--field-border);
        outline: 2px solid var(--field-info);
      }

      .field-button.primary {
        border-color: var(--field-info);
        background-color: rgba(0, 136, 255, 0.2);
      }

      .coordinates {
        font-family: "Courier New", monospace;
        font-size: 14px;
        margin: 5px 0;
      }

      .system-stats {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
        margin-bottom: 20px;
      }

      .stat-item {
        text-align: center;
        padding: 10px;
        border: 1px solid var(--field-border);
        border-radius: 4px;
        font-size: 14px;
      }

      .large-text {
        font-size: 24px;
        font-weight: bold;
        text-align: center;
        margin: 20px 0;
        padding: 20px;
        border: 2px solid var(--field-info);
        border-radius: 8px;
      }

      .alert-banner {
        background-color: var(--field-danger);
        color: var(--field-secondary);
        padding: 15px;
        text-align: center;
        font-weight: bold;
        font-size: 18px;
        margin-bottom: 20px;
        border-radius: 8px;
        animation: pulse 2s infinite;
      }

      /* Mobile optimizations */
      @media (max-width: 480px) {
        body {
          font-size: 16px;
        }

        .status-grid {
          grid-template-columns: 1fr;
        }

        .system-stats {
          grid-template-columns: 1fr 1fr;
        }

        .field-button {
          font-size: 14px;
          padding: 12px;
        }
      }

      /* High contrast mode */
      @media (prefers-contrast: high) {
        :root {
          --field-border: #000000;
        }

        .status-card,
        .field-button,
        .gps-info,
        .recent-detections {
          border-width: 3px;
        }
      }
    </style>
  </head>
  <body>
    <div class="field-container">
      <h1>{{ site_name }}</h1>
      <h2>{{ _('Field Mode') }}</h2>

      <!-- Alert Banner -->
      <div id="alertBanner" class="alert-banner" style="display: none"></div>

      <!-- System Status -->
      <div class="status-grid">
        <div id="audioStatus" class="status-card">
          <div>{{ _('Audio') }}</div>
          <div id="audioStatusText">{{ _('Checking...') }}</div>
        </div>
        <div id="gpsStatus" class="status-card">
          <div>{{ _('GPS') }}</div>
          <div id="gpsStatusText">{{ _('Checking...') }}</div>
        </div>
        <div id="systemStatus" class="status-card">
          <div>{{ _('System') }}</div>
          <div id="systemStatusText">{{ _('Checking...') }}</div>
        </div>
        <div id="detectionStatus" class="status-card">
          <div>{{ _('Detection') }}</div>
          <div id="detectionStatusText">{{ _('Active') }}</div>
        </div>
      </div>

      <!-- GPS Information -->
      <div class="gps-info">
        <h3>{{ _('Location') }}</h3>
        <div id="gpsCoordinates" class="coordinates">
          {{ _('GPS: Not available') }}
        </div>
        <div id="gpsAccuracy" class="coordinates">
          {{ _('Accuracy: Unknown') }}
        </div>
        <div id="gpsSatellites" class="coordinates">
          {{ _('Satellites: --') }}
        </div>
        <div id="gpsLastUpdate" class="coordinates">
          {{ _('Last update: Never') }}
        </div>
      </div>

      <!-- System Statistics -->
      <div class="system-stats">
        <div class="stat-item">
          <div>{{ _('CPU') }}</div>
          <div id="cpuUsage">--%</div>
        </div>
        <div class="stat-item">
          <div>{{ _('Memory') }}</div>
          <div id="memoryUsage">--%</div>
        </div>
        <div class="stat-item">
          <div>{{ _('Disk') }}</div>
          <div id="diskUsage">--%</div>
        </div>
      </div>

      <!-- Control Buttons -->
      <div class="control-buttons">
        <a href="/livestream" class="field-button primary">
          üîä {{ _('Live Audio') }}
        </a>
        <a href="/spectrogram" class="field-button primary">
          üìä {{ _('Spectrogram') }}
        </a>
        <button id="refreshBtn" class="field-button" onclick="refreshStatus()">
          üîÑ {{ _('Refresh') }}
        </button>
        <a href="/" class="field-button">üè† {{ _('Home') }}</a>
      </div>

      <!-- Recent Detections -->
      <div class="recent-detections">
        <h3>{{ _('Recent Detections') }}</h3>
        <div id="detectionsList">{{ _('Loading detections...') }}</div>
      </div>

      <!-- Detection Count -->
      <div class="large-text">
        {{ _('Total Today:') }} <span id="todayCount">--</span>
      </div>
    </div>

    <script>
      // Field mode JavaScript
      let statusUpdateInterval;
      let websocket = null;

      // Initialize field mode
      document.addEventListener("DOMContentLoaded", function () {
        startStatusUpdates();
        connectWebSocket();
        refreshDetections();
      });

      function startStatusUpdates() {
        // Update status immediately and then every 5 seconds
        updateStatus();
        statusUpdateInterval = setInterval(updateStatus, 5000);
      }

      function connectWebSocket() {
        const wsUrl = `ws://${window.location.hostname}:${window.location.port}/ws`;
        websocket = new WebSocket(wsUrl);

        websocket.onopen = function (event) {
          console.log("WebSocket connected");
        };

        websocket.onmessage = function (event) {
          try {
            const data = JSON.parse(event.data);
            if (data.type === "detection") {
              addNewDetection(data);
              updateTodayCount();
            }
          } catch (e) {
            console.error("Error parsing WebSocket message:", e);
          }
        };

        websocket.onclose = function (event) {
          console.log("WebSocket disconnected, reconnecting...");
          setTimeout(connectWebSocket, 5000);
        };

        websocket.onerror = function (error) {
          console.error("WebSocket error:", error);
        };
      }

      async function updateStatus() {
        try {
          // Get hardware status
          const hardwareResponse = await fetch("/api/hardware/status");
          const hardwareData = await hardwareResponse.json();
          updateHardwareStatus(hardwareData);

          // Get GPS status
          const gpsResponse = await fetch("/api/gps/status");
          const gpsData = await gpsResponse.json();
          updateGPSStatus(gpsData);
        } catch (error) {
          console.error("Error updating status:", error);
          showAlert("Connection error - check network");
        }
      }

      function updateHardwareStatus(data) {
        const components = data.components || {};

        // Update audio status
        const audioComponent = components.audio_input;
        updateStatusCard(
          "audioStatus",
          "audioStatusText",
          audioComponent,
          "Working",
          "Audio Error",
        );

        // Update system status (combine CPU, memory, disk)
        const cpuComponent = components.cpu;
        const memoryComponent = components.memory;
        const diskComponent = components.disk;

        let systemStatus = "healthy";
        let systemText = "Normal";

        if (
          cpuComponent?.status === "critical" ||
          memoryComponent?.status === "critical" ||
          diskComponent?.status === "critical"
        ) {
          systemStatus = "critical";
          systemText = "Critical";
        } else if (
          cpuComponent?.status === "warning" ||
          memoryComponent?.status === "warning" ||
          diskComponent?.status === "warning"
        ) {
          systemStatus = "warning";
          systemText = "Warning";
        }

        updateStatusCard(
          "systemStatus",
          "systemStatusText",
          { status: systemStatus },
          systemText,
          "System Issue",
        );

        // Update system statistics
        if (cpuComponent?.details?.usage_percent !== undefined) {
          document.getElementById("cpuUsage").textContent =
            cpuComponent.details.usage_percent.toFixed(1) + "%";
        }
        if (memoryComponent?.details?.usage_percent !== undefined) {
          document.getElementById("memoryUsage").textContent =
            memoryComponent.details.usage_percent.toFixed(1) + "%";
        }
        if (diskComponent?.details?.usage_percent !== undefined) {
          document.getElementById("diskUsage").textContent =
            diskComponent.details.usage_percent.toFixed(1) + "%";
        }
      }

      function updateGPSStatus(data) {
        const gpsStatusCard = document.getElementById("gpsStatus");
        const gpsStatusText = document.getElementById("gpsStatusText");
        const coordinates = document.getElementById("gpsCoordinates");
        const accuracy = document.getElementById("gpsAccuracy");
        const satellites = document.getElementById("gpsSatellites");
        const lastUpdate = document.getElementById("gpsLastUpdate");

        if (data.enabled && data.has_fix) {
          gpsStatusCard.className = "status-card status-healthy";
          gpsStatusText.textContent = "Active";

          if (data.coordinates) {
            coordinates.textContent = `GPS: ${data.coordinates.latitude.toFixed(
              6,
            )}, ${data.coordinates.longitude.toFixed(6)}`;
          }

          if (data.accuracy) {
            accuracy.textContent = `Accuracy: ¬±${data.accuracy.toFixed(1)}m`;
          }

          if (data.satellite_count) {
            satellites.textContent = `Satellites: ${data.satellite_count}`;
          }

          if (data.last_update) {
            const updateTime = new Date(data.last_update);
            lastUpdate.textContent = `Last update: ${updateTime.toLocaleTimeString()}`;
          }
        } else if (data.enabled) {
          gpsStatusCard.className = "status-card status-warning";
          gpsStatusText.textContent = "Searching";
          coordinates.textContent = "GPS: Searching for signal...";
          accuracy.textContent = "Accuracy: Unknown";
          satellites.textContent = "Satellites: Searching";
        } else {
          gpsStatusCard.className = "status-card status-warning";
          gpsStatusText.textContent = "Disabled";
          coordinates.textContent = "GPS: Disabled";
          accuracy.textContent = "Accuracy: Not available";
          satellites.textContent = "Satellites: --";
        }
      }

      function updateStatusCard(
        cardId,
        textId,
        component,
        healthyText,
        errorText,
      ) {
        const card = document.getElementById(cardId);
        const text = document.getElementById(textId);

        if (!component || component.status === "unknown") {
          card.className = "status-card";
          text.textContent = "Unknown";
        } else if (component.status === "healthy") {
          card.className = "status-card status-healthy";
          text.textContent = healthyText;
        } else if (component.status === "warning") {
          card.className = "status-card status-warning";
          text.textContent = "Warning";
        } else if (component.status === "critical") {
          card.className = "status-card status-critical";
          text.textContent = errorText;
          showAlert(`${errorText}: ${component.message || "Check system"}`);
        }
      }

      async function refreshDetections() {
        try {
          const response = await fetch("/api/detections/recent?limit=5");
          const data = await response.json();
          displayDetections(data.detections || []);
          updateTodayCount();
        } catch (error) {
          console.error("Error fetching detections:", error);
          document.getElementById("detectionsList").innerHTML =
            "<p>Error loading detections</p>";
        }
      }

      function displayDetections(detections) {
        const list = document.getElementById("detectionsList");
        if (detections.length === 0) {
          list.innerHTML = "<p>No recent detections</p>";
          return;
        }

        list.innerHTML = detections
          .map(
            (detection) => `
            <div class="detection-item">
              <div>
                <div class="detection-species">${detection.species}</div>
                <div class="detection-time">${formatTime(
                  detection.timestamp,
                )}</div>
              </div>
              <div class="detection-confidence">${(
                detection.confidence * 100
              ).toFixed(1)}%</div>
            </div>
          `,
          )
          .join("");
      }

      function addNewDetection(detection) {
        // Add new detection to the top of the list
        const list = document.getElementById("detectionsList");
        const newItem = document.createElement("div");
        newItem.className = "detection-item";
        newItem.innerHTML = `
          <div>
            <div class="detection-species">${detection.species}</div>
            <div class="detection-time">${formatTime(detection.timestamp)}</div>
          </div>
          <div class="detection-confidence">${(
            detection.confidence * 100
          ).toFixed(1)}%</div>
        `;

        // Insert at the beginning
        list.insertBefore(newItem, list.firstChild);

        // Remove excess items (keep only 5)
        const items = list.querySelectorAll(".detection-item");
        if (items.length > 5) {
          items[items.length - 1].remove();
        }

        // Flash the detection status
        const detectionStatus = document.getElementById("detectionStatus");
        detectionStatus.style.backgroundColor = "rgba(0, 255, 0, 0.3)";
        setTimeout(() => {
          detectionStatus.style.backgroundColor = "";
        }, 1000);
      }

      async function updateTodayCount() {
        try {
          const today = new Date().toISOString().split("T")[0];
          const response = await fetch(`/api/detections/count?date=${today}`);
          const data = await response.json();
          document.getElementById("todayCount").textContent =
            data.count || "--";
        } catch (error) {
          console.error("Error fetching today count:", error);
        }
      }

      function formatTime(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function showAlert(message) {
        const banner = document.getElementById("alertBanner");
        banner.textContent = message;
        banner.style.display = "block";

        // Auto-hide after 10 seconds
        setTimeout(() => {
          banner.style.display = "none";
        }, 10000);
      }

      function refreshStatus() {
        const btn = document.getElementById("refreshBtn");
        btn.textContent = "üîÑ Refreshing...";
        btn.disabled = true;

        updateStatus().finally(() => {
          btn.textContent = "üîÑ Refresh";
          btn.disabled = false;
        });

        refreshDetections();
      }

      // Clean up on page unload
      window.addEventListener("beforeunload", function () {
        if (statusUpdateInterval) {
          clearInterval(statusUpdateInterval);
        }
        if (websocket) {
          websocket.close();
        }
      });
    </script>
  </body>
</html>
