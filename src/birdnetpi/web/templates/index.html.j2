<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BirdNET-Pi</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: Georgia, "Times New Roman", serif;
        background: #fdfcfa;
        color: #2c2c2c;
        line-height: 1.5;
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
      }

      /* Header - minimal identification */
      header {
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid #111;
      }

      h1 {
        font-size: 1.5rem;
        font-weight: normal;
        margin-bottom: 0.25rem;
      }

      .tagline {
        font-size: 0.9rem;
        color: #666;
        font-style: italic;
      }

      /* Hero Visualization Section */
      .hero-viz {
        margin-bottom: 2rem;
        background: linear-gradient(135deg, #fdfcfa 0%, #f8f6f2 100%);
        position: relative;
        overflow: hidden;
        height: 320px;
      }

      #visualization {
        width: 100%;
        height: 100%;
        position: relative;
      }

      .dot {
        position: absolute;
        border-radius: 50%;
        mix-blend-mode: multiply;
        animation: gentle-pulse 4s ease-in-out infinite;
        opacity: 0;
        transition: opacity 1s ease-in;
      }

      .dot.visible {
        opacity: 0.12;
      }

      @keyframes gentle-pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }

      .dot-ring {
        position: absolute;
        border-radius: 50%;
        border: 1px solid;
        opacity: 0.08;
        pointer-events: none;
        animation: expand 8s linear infinite;
      }

      @keyframes expand {
        0% {
          transform: scale(1);
          opacity: 0.08;
        }
        100% {
          transform: scale(3);
          opacity: 0;
        }
      }

      .activity-wave {
        position: absolute;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent 0%,
          rgba(46, 125, 50, 0.03) 20%,
          rgba(245, 124, 0, 0.03) 50%,
          rgba(198, 40, 40, 0.03) 80%,
          transparent 100%
        );
        animation: wave 30s linear infinite;
        opacity: 0.5;
      }

      @keyframes wave {
        0% {
          transform: translateX(-100%);
        }
        100% {
          transform: translateX(100%);
        }
      }

      .time-gradient {
        position: absolute;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          rgba(30, 30, 80, 0.02) 0%,
          /* night */ rgba(255, 183, 77, 0.05) 25%,
          /* dawn */ rgba(255, 255, 255, 0) 50%,
          /* midday */ rgba(255, 152, 0, 0.05) 75%,
          /* dusk */ rgba(30, 30, 80, 0.02) 100%
        ); /* night */
        pointer-events: none;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0) translateX(0);
          opacity: 0.05;
        }
        25% {
          transform: translateY(-30px) translateX(20px);
          opacity: 0.1;
        }
        50% {
          transform: translateY(20px) translateX(-10px);
          opacity: 0.08;
        }
        75% {
          transform: translateY(-10px) translateX(30px);
          opacity: 0.12;
        }
      }

      /* Navigation - prominent but minimal */
      .main-nav {
        display: flex;
        gap: 0;
        margin-bottom: 1.5rem;
        border-bottom: 2px solid #111;
        border-top: 1px solid #111;
        background: #f8f8f8;
      }

      .nav-item {
        padding: 0.5rem 1rem;
        color: #111;
        text-decoration: none;
        font-size: 0.9rem;
        border-right: 1px solid #ddd;
        transition: background 0.2s;
      }

      .nav-item:hover {
        background: #fff;
        text-decoration: underline;
      }

      .nav-item:last-child {
        border-right: none;
      }

      /* Primary metrics - inline presentation */
      .primary-metrics {
        font-size: 1rem;
        margin-bottom: 1.5rem;
        line-height: 1.8;
      }

      .metric {
        color: #111;
        font-weight: normal;
      }

      /* System status - horizontal bar */
      .system-status {
        display: flex;
        gap: 0;
        margin-bottom: 1.5rem;
        height: 32px;
        background: #f8f8f6;
        border: 1px solid #e0e0e0;
        position: relative;
        overflow: hidden;
      }

      .status-segment {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        border-right: 1px solid #e0e0e0;
        padding: 0 0.75rem;
        min-width: 0;
        transition: background 0.3s ease;
      }

      .status-segment:last-child {
        border-right: none;
      }

      .status-segment:hover {
        background: rgba(255, 255, 255, 0.5);
      }

      .status-indicator {
        position: absolute;
        bottom: 0;
        left: 0;
        height: 2px;
        background: #4caf50;
        transition:
          width 0.3s ease,
          background 0.3s ease;
      }

      .status-indicator.warning {
        background: #ff9800;
      }

      .status-indicator.critical {
        background: #f44336;
      }

      .status-label {
        font-size: 0.7rem;
        color: #999;
        margin-right: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .status-value {
        font-size: 0.85rem;
        color: #333;
        font-weight: 500;
      }

      .status-detail {
        font-size: 0.7rem;
        color: #666;
        margin-left: 0.25rem;
      }

      /* Tooltip for status segments */
      .status-tooltip {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 4px 8px;
        border-radius: 3px;
        font-size: 0.75rem;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s;
        margin-bottom: 4px;
      }

      .status-segment:hover .status-tooltip {
        opacity: 1;
      }

      /* Main grid */
      .main-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
      }

      /* Detection log */
      .detection-log {
        font-size: 0.85rem;
      }

      .log-header {
        font-weight: normal;
        margin-bottom: 0.5rem;
        padding-bottom: 0.25rem;
        border-bottom: 1px solid #111;
        display: grid;
        grid-template-columns: 60px 1fr 60px;
        gap: 1rem;
      }

      .log-entry {
        display: grid;
        grid-template-columns: 60px 1fr 60px;
        gap: 1rem;
        padding: 0.3rem 0;
        border-bottom: 1px dotted #e0e0e0;
        transition: background 0.1s;
      }

      .log-entry:hover {
        background: #f8f8f8;
      }

      .time {
        color: #666;
        font-size: 0.8rem;
      }

      .confidence {
        text-align: right;
        font-size: 0.8rem;
      }

      .count {
        text-align: right;
        font-size: 0.8rem;
        color: #666;
      }

      /* Species frequency list */
      .frequency-list {
        font-size: 0.85rem;
      }

      .list-header {
        font-weight: normal;
        margin-bottom: 0.5rem;
        padding-bottom: 0.25rem;
        border-bottom: 1px solid #111;
      }

      .frequency-item {
        display: grid;
        grid-template-columns: 1fr 40px 40px;
        gap: 0.5rem;
        padding: 0.3rem 0;
        border-bottom: 1px dotted #e0e0e0;
      }

      .frequency-item:hover {
        background: #f8f8f8;
      }

      .species-name {
        font-size: 0.85rem;
      }

      .freq-count {
        text-align: right;
        font-size: 0.8rem;
      }

      .freq-bar {
        display: flex;
        align-items: center;
        justify-content: flex-end;
      }

      .bar {
        height: 3px;
        background: #666;
        display: inline-block;
      }

      /* Live indicator */
      .live {
        display: inline-block;
        width: 6px;
        height: 6px;
        background: #d32f2f;
        border-radius: 50%;
        margin-left: 0.5rem;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.3;
        }
      }

      /* Annotations */
      .annotation {
        font-size: 0.75rem;
        color: #666;
        font-style: italic;
        margin-top: 1rem;
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .main-grid {
          grid-template-columns: 1fr;
        }

        .log-header,
        .log-entry {
          grid-template-columns: 50px 1fr 50px;
        }

        .count {
          display: none;
        }

        .hero-viz {
          height: 240px;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>{{ site_name | default('BirdNET-Pi') }} <span class="live" title="System Active"></span></h1>
      <p class="tagline">
        Continuous acoustic monitoring · {{ system_status.device_name | default('Unknown Device') }} · {{ location | default('Location not set') }}
      </p>
    </header>

    <!-- Navigation -->
    <nav class="main-nav">
      <a href="/reports/detections" class="nav-item">Detections</a>
      <a href="/reports/best" class="nav-item">Best Recordings</a>
      <a href="/livestream" class="nav-item">Audio Stream</a>
      <a href="/reports" class="nav-item">Analysis</a>
      <a href="/field" class="nav-item">Field Recording</a>
      <a href="/admin/settings" class="nav-item">Settings</a>
      <a href="/api/system/overview" class="nav-item">API</a>
    </nav>

    <!-- Hero Visualization -->
    <div class="hero-viz">
      <div id="visualization">
        <div class="time-gradient"></div>
        <div class="activity-wave"></div>
      </div>
    </div>

    <!-- Primary metrics - inline presentation -->
    <div class="primary-metrics">
      <span class="metric">{{ metrics.species_detected }}</span> species detected ·
      <span class="metric">{{ metrics.detections_today }}</span> detections today ·
      <span class="metric">{{ metrics.species_week }}</span> active species this week ·
      <span class="metric">{{ metrics.storage }}</span> recordings ·
      <span class="metric">{{ metrics.hours }}</span> hours monitored · Confidence threshold
      <span class="metric">{{ metrics.threshold }}</span>
    </div>

    <!-- System status bar -->
    <div class="system-status">
      <div class="status-segment">
        <span class="status-tooltip">CPU Temperature: {{ system_status.cpu.temp }}°C</span>
        <span class="status-label">CPU</span>
        <span class="status-value">{{ system_status.cpu.percent | round | int }}%</span>
        <span class="status-indicator" style="width: {{ system_status.cpu.percent }}%"></span>
      </div>

      <div class="status-segment">
        <span class="status-tooltip">{{ system_status.memory.used_gb | round(1) }} GB / {{ system_status.memory.total_gb | round(1) }} GB used</span>
        <span class="status-label">Mem</span>
        <span class="status-value">{{ system_status.memory.percent | round | int }}%</span>
        <span class="status-indicator" style="width: {{ system_status.memory.percent }}%"></span>
      </div>

      <div class="status-segment">
        <span class="status-tooltip">{{ system_status.disk.used_gb | round(1) }} GB / {{ system_status.disk.total_gb | round(1) }} GB used</span>
        <span class="status-label">Disk</span>
        <span class="status-value">{{ system_status.disk.percent | round | int }}%</span>
        <span class="status-indicator {% if system_status.disk.percent > 80 %}warning{% elif system_status.disk.percent > 90 %}critical{% endif %}" style="width: {{ system_status.disk.percent }}%"></span>
      </div>

      <div class="status-segment">
        <span class="status-tooltip">{{ system_status.audio.device }} · 48 kHz</span>
        <span class="status-label">Audio</span>
        <span class="status-value"
          >{{ system_status.audio.level_db }}<span class="status-detail">dB</span></span
        >
        <span class="status-indicator" style="width: {{ system_status.audio.level_percent }}%"></span>
      </div>

      <div class="status-segment">
        <span class="status-tooltip">System uptime</span>
        <span class="status-label">Up</span>
        <span class="status-value">{{ system_status.uptime }}d</span>
        <span class="status-indicator" style="width: 100%"></span>
      </div>
    </div>

    <!-- Main content grid -->
    <div class="main-grid">
      <!-- Detection log -->
      <div class="detection-log">
        <div class="log-header">
          <span>Time</span>
          <span>Species</span>
          <span>Conf.</span>
        </div>
        {% for detection in detection_log[:10] %}
        <div class="log-entry">
          <span class="time">{{ detection.time }}</span>
          <span>{{ detection.species }}</span>
          <span class="confidence">{{ detection.confidence }}</span>
        </div>
        {% endfor %}
        {% if not detection_log %}
        <div class="log-entry">
          <span class="time">--:--</span>
          <span>No recent detections</span>
          <span class="confidence">--</span>
        </div>
        {% endif %}
      </div>

      <!-- Species frequency -->
      <div class="frequency-list">
        <div class="list-header">Today's Species (24h)</div>
        {% for species in species_frequency[:10] %}
        <div class="frequency-item">
          <span class="species-name">{{ species.name }}</span>
          <span class="freq-count">{{ species.count }}</span>
          <span class="freq-bar"
            ><span class="bar" style="width: {{ species.bar_width }}"></span
          ></span>
        </div>
        {% endfor %}
        {% if not species_frequency %}
        <div class="frequency-item">
          <span class="species-name">No species detected today</span>
          <span class="freq-count">0</span>
          <span class="freq-bar"
            ><span class="bar" style="width: 0%"></span
          ></span>
        </div>
        {% endif %}
      </div>
    </div>

    <p class="annotation">
      BirdNET v2.4 · Confidence threshold ≥0.70 · UTC-05:00 · Last model update:
      2025-01-15 · Microphone: USB Audio Device (48 kHz, 16-bit) · Recording: 3s
      segments every 12s
    </p>

    <script>
      // Build species data from server-provided frequency data
      const speciesData = {};
      {% for species in species_frequency %}
      speciesData["{{ species.name }}"] = {
        count: {{ species.count }},
        color: {{ species.count }} > 200 ? "#2e7d32" : {{ species.count }} > 50 ? "#f57c00" : "#c62828"
      };
      {% endfor %}

      // Get hourly distribution from server
      const hourlyDistribution = {{ hourly_distribution | tojson }};

      // Get visualization data from server
      const visualizationData = {{ visualization_data | tojson }};

      // Use real detection data or generate based on hourly distribution
      function generateDetections() {
        const detections = [];

        // If we have real visualization data, use it
        if (visualizationData && visualizationData.length > 0) {
          visualizationData.forEach(d => {
            detections.push({
              time: d.x,  // Already in hours (0-24)
              confidence: d.y * 100,  // Convert from fraction to percentage
              species: d.species,
              color: d.color,
              count: 1
            });
          });
        } else if (hourlyDistribution && hourlyDistribution.length > 0) {
          // Generate based on hourly distribution
          const species = Object.keys(speciesData);

          hourlyDistribution.forEach((count, hour) => {
            for (let i = 0; i < count; i++) {
              detections.push({
                time: hour + Math.random(),
                confidence: 70 + Math.random() * 30,
                species: species.length > 0 ? species[Math.floor(Math.random() * species.length)] : "Unknown",
                count: 1
              });
            }
          });
        } else {
          // Fallback to minimal mock data
          for (let i = 0; i < 50; i++) {
            detections.push({
              time: Math.random() * 24,
              confidence: 70 + Math.random() * 30,
              species: "Unknown",
              count: 1
            });
          }
        }

        return detections;
      }

      // Draw the abstract visualization
      function drawVisualization() {
        const container = document.getElementById("visualization");
        const detections = generateDetections();

        detections.forEach((d, index) => {
          // Create main dot
          const dot = document.createElement("div");
          dot.className = "dot";

          // Position based on time (x) and pseudo-random vertical spread
          const x = (d.time / 24) * 100;

          // Create vertical bands with organic clustering
          const verticalSpread = Math.sin(d.time * 0.5) * 30 + 50;
          const y =
            verticalSpread +
            (Math.random() - 0.5) * 40 +
            Math.sin(index * 0.1) * 10;

          // Size based on count and confidence
          const baseSize = 8 + d.count * 4 + (d.confidence - 70) * 0.5;
          const size = baseSize + Math.random() * 20;

          // Color based on species frequency with more variation
          const baseColor = d.color || (speciesData[d.species] ? speciesData[d.species].color : "#666");
          const opacity = 0.12 + Math.random() * 0.08;

          // Apply styles
          dot.style.left = `${x}%`;
          dot.style.top = `${y}%`;
          dot.style.width = `${size}px`;
          dot.style.height = `${size}px`;
          dot.style.background = baseColor;

          // Staggered animation
          setTimeout(() => {
            dot.classList.add("visible");
          }, index * 3);

          // Random animation delay for organic movement
          dot.style.animationDelay = `${Math.random() * 4}s`;

          container.appendChild(dot);

          // Add expanding rings for high-confidence detections
          if (d.confidence > 90 && Math.random() > 0.7) {
            const ring = document.createElement("div");
            ring.className = "dot-ring";
            ring.style.left = `${x}%`;
            ring.style.top = `${y}%`;
            ring.style.width = `${size}px`;
            ring.style.height = `${size}px`;
            ring.style.borderColor = baseColor;
            ring.style.animationDelay = `${Math.random() * 8}s`;
            container.appendChild(ring);
          }
        });

        // Add floating particle effect for ambient movement
        for (let i = 0; i < 20; i++) {
          const particle = document.createElement("div");
          particle.className = "dot";
          particle.style.width = "2px";
          particle.style.height = "2px";
          particle.style.background = "#999";
          particle.style.left = `${Math.random() * 100}%`;
          particle.style.top = `${Math.random() * 100}%`;
          particle.style.animation = `float ${20 + Math.random() * 10}s infinite ease-in-out`;
          particle.style.animationDelay = `${Math.random() * 5}s`;
          particle.classList.add("visible");
          container.appendChild(particle);
        }
      }

      // Update times in detection log
      function updateTimes() {
        const now = new Date();
        const timeElements = document.querySelectorAll(".log-entry .time");

        timeElements.forEach((el, index) => {
          const minutesAgo = index * 5 + Math.floor(Math.random() * 5);
          const time = new Date(now - minutesAgo * 60000);
          el.textContent = time.toTimeString().slice(0, 5);
        });
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        drawVisualization();
        updateTimes();

        // Update times every minute
        setInterval(updateTimes, 60000);

        // Simulate live updates
        setInterval(() => {
          const pulse = document.querySelector(".live");
          if (pulse) {
            pulse.style.background = "#4caf50";
            setTimeout(() => {
              pulse.style.background = "#d32f2f";
            }, 1000);
          }
        }, 10000);

        // TODO: Replace with WebSocket connection for real-time system updates
        // For now, the values from the backend are displayed statically
      });
    </script>
  </body>
</html>
