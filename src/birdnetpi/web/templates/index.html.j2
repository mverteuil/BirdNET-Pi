<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BirdNET-Pi</title>
    <link rel="stylesheet" href="{{ request.url_for('static', path='style.css') }}" />
    <link rel="stylesheet" href="{{ request.url_for('static', path='css/dashboard.css') }}" />
  </head>
  <body>
    <header>
      <h1>{{ site_name | default('BirdNET-Pi') }} <span class="live" title="System Active"></span></h1>
      <p class="tagline">
        Continuous acoustic monitoring · <span id="device-name">Loading...</span> · {{ location | default('Location not set') }}
      </p>
    </header>

    <!-- Navigation -->
    {% set active_page = 'dashboard' %}
    {% include 'includes/navigation.html.j2' %}

    <!-- Hero Visualization -->
    <div class="hero-viz">
      <div id="visualization">
        <div class="time-gradient"></div>
        <div class="activity-wave"></div>
      </div>
    </div>

    <!-- Primary metrics - inline presentation -->
    <div class="primary-metrics">
      <span class="metric">{{ metrics.species_detected }}</span> species detected ·
      <span class="metric">{{ metrics.detections_today }}</span> detections today ·
      <span class="metric">{{ metrics.species_week }}</span> active species this week ·
      <span class="metric">{{ metrics.storage }}</span> recordings ·
      <span class="metric">{{ metrics.hours }}</span> hours monitored · Confidence threshold
      <span class="metric">{{ metrics.threshold }}</span>
    </div>

    <!-- System status bar (progressively loaded) -->
    <div class="system-status" id="system-status">
      <div class="status-segment">
        <span class="status-tooltip" id="cpu-tooltip">Loading...</span>
        <span class="status-label">CPU</span>
        <span class="status-value" id="cpu-value">--</span>
        <span class="status-indicator" id="cpu-indicator" style="width: 0%"></span>
      </div>

      <div class="status-segment">
        <span class="status-tooltip" id="memory-tooltip">Loading...</span>
        <span class="status-label">Mem</span>
        <span class="status-value" id="memory-value">--</span>
        <span class="status-indicator" id="memory-indicator" style="width: 0%"></span>
      </div>

      <div class="status-segment">
        <span class="status-tooltip" id="disk-tooltip">Loading...</span>
        <span class="status-label">Disk</span>
        <span class="status-value" id="disk-value">--</span>
        <span class="status-indicator" id="disk-indicator" style="width: 0%"></span>
      </div>

      <div class="status-segment">
        <span class="status-tooltip" id="audio-tooltip">Loading...</span>
        <span class="status-label">Audio</span>
        <span class="status-value" id="audio-value">--</span>
        <span class="status-indicator" id="audio-indicator" style="width: 0%"></span>
      </div>

      <div class="status-segment">
        <span class="status-tooltip" id="uptime-tooltip">System uptime</span>
        <span class="status-label">Up</span>
        <span class="status-value" id="uptime-value">--</span>
        <span class="status-indicator" id="uptime-indicator" style="width: 100%"></span>
      </div>
    </div>

    <!-- Main content grid -->
    <div class="main-grid">
      <!-- Detection log -->
      <div class="detection-log">
        <div class="log-header">
          <span>Time</span>
          <span>Species</span>
          <span>Conf.</span>
        </div>
        {% for detection in detection_log[:10] %}
        <div class="log-entry">
          <span class="time">{{ detection.time }}</span>
          <span>{{ detection.species }}</span>
          <span class="confidence">{{ detection.confidence }}</span>
        </div>
        {% endfor %}
        {% if not detection_log %}
        <div class="log-entry">
          <span class="time">--:--</span>
          <span>No recent detections</span>
          <span class="confidence">--</span>
        </div>
        {% endif %}
      </div>

      <!-- Species frequency -->
      <div class="frequency-list">
        <div class="list-header">Today's Species (24h)</div>
        {% for species in species_frequency[:10] %}
        <div class="frequency-item">
          <span class="species-name">{{ species.name }}</span>
          <span class="freq-count">{{ species.count }}</span>
          <span class="freq-bar"
            ><span class="bar" style="width: {{ species.bar_width }}"></span
          ></span>
        </div>
        {% endfor %}
        {% if not species_frequency %}
        <div class="frequency-item">
          <span class="species-name">No species detected today</span>
          <span class="freq-count">0</span>
          <span class="freq-bar"
            ><span class="bar" style="width: 0%"></span
          ></span>
        </div>
        {% endif %}
      </div>
    </div>

    <p class="annotation">
      BirdNET v2.4 · Confidence threshold ≥0.70 · UTC-05:00 · Last model update:
      2025-01-15 · Microphone: USB Audio Device (48 kHz, 16-bit) · Recording: 3s
      segments every 12s
    </p>

    <!-- Detection notification banner (initially hidden) -->
    <div id="detection-banner" class="detection-banner d-none">
      <span class="banner-content"></span>
    </div>

    <!-- Load dashboard JavaScript with cache busting -->
    <script src="{{ url_for('static', path='js/dashboard.js') }}?v={{ range(1000, 9999) | random }}"></script>

    <script>
      // Initialize data from server
      const speciesFrequencyData = {{ species_frequency | tojson }};
      const hourlyDistributionData = {{ hourly_distribution | tojson }};
      const visualizationDataFromServer = {{ visualization_data | tojson }};

      // Pass data to dashboard functions
      document.addEventListener("DOMContentLoaded", () => {
        initializeSpeciesData(speciesFrequencyData);
        setHourlyDistribution(hourlyDistributionData);
        setVisualizationData(visualizationDataFromServer);
      });

      // Note: All main functions are now in dashboard.js
    </script>
  </body>
</html>
