<!doctype html>
<html>
  <head>
    <title>BirdNET-Pi Views</title>
    <link rel="stylesheet" href="/static/style.css" />
    <link rel="stylesheet" type="text/css" href="/static/dialog-polyfill.css" />
  </head>
  <body>
    <div class="topnav" id="myTopnav">
      <button type="button" onclick="loadOverview()">Overview</button>
      <button type="button" onclick="loadTodaysDetections()">
        Today's Detections
      </button>
      <button type="button" onclick="loadSpectrogram()">Spectrogram</button>
      <button type="button" onclick="loadBestRecordings()">
        Best Recordings
      </button>

      <form action="" method="GET">
        <button type="submit" name="view" value="Daily Charts" form="views">
          Daily Charts
        </button>
      </form>
      <button type="button" onclick="loadRecordings()">Recordings</button>
      <button type="button" onclick="loadLog()">View Log</button>
      <button
        type="button"
        onclick="window.open('/test_detection_form', '_blank', 'width=600,height=400')"
      >
        Test Detection
      </button>
      <form action="" id="toolsbtn" method="GET">
        <button type="submit" name="view" value="Tools" form="views">
          Tools{% if commits_behind > 0 %}
          <div class="updatenumber">{{ commits_behind }}</div>
          {% endif %}
        </button>
      </form>
      <button href="javascript:void(0);" class="icon" onclick="myFunction()">
        <img src="/static/images/menu.png" />
      </button>
    </div>

    <script>
      function myFunction() {
        var x = document.getElementById("myTopnav");
        if (x.className === "topnav") {
          x.className += " responsive";
        } else {
          x.className = "topnav";
        }
      }
    </script>

    <div class="views">
      <pre id="logContent"></pre>
      <ul id="recordingsList"></ul>
      <ul id="bestRecordingsList"></ul>
      <img
        id="spectrogramImage"
        src=""
        alt="Spectrogram"
        style="display: none"
      />
      <ul id="todaysDetectionsList"></ul>
      <div id="overviewContent"></div>
    </div>

    <script>
      async function loadLog() {
        const response = await fetch("/log");
        const logText = await response.text();
        document.getElementById("logContent").textContent = logText;
      }

      async function loadRecordings() {
        const response = await fetch("/recordings");
        const data = await response.json();
        const recordingsList = document.getElementById("recordingsList");
        recordingsList.innerHTML = ""; // Clear previous list
        data.recordings.forEach((recording) => {
          const listItem = document.createElement("li");
          listItem.textContent = recording;
          recordingsList.appendChild(listItem);
        });
      }

      async function loadBestRecordings() {
        const response = await fetch("/best_recordings");
        const data = await response.json();
        const bestRecordingsList =
          document.getElementById("bestRecordingsList");
        bestRecordingsList.innerHTML = ""; // Clear previous list
        data.best_recordings.forEach((recording) => {
          const listItem = document.createElement("li");
          listItem.textContent = `${recording.species} - ${recording.confidence} - ${recording.timestamp}`;
          bestRecordingsList.appendChild(listItem);
        });
      }

      async function loadSpectrogram() {
        // For demonstration, let's assume a sample audio file path
        // In a real scenario, this would come from user selection or a recording list
        const sampleAudioPath = "/path/to/your/audio.wav"; // TODO: Replace with dynamic audio path
        const response = await fetch(
          `/spectrogram?audio_path=${encodeURIComponent(sampleAudioPath)}`,
        );
        const imageBlob = await response.blob();
        const imageUrl = URL.createObjectURL(imageBlob);
        const spectrogramImage = document.getElementById("spectrogramImage");
        spectrogramImage.src = imageUrl;
        spectrogramImage.style.display = "block";
      }

      async function loadTodaysDetections() {
        const response = await fetch("/todays_detections");
        const data = await response.json();
        const todaysDetectionsList = document.getElementById(
          "todaysDetectionsList",
        );
        todaysDetectionsList.innerHTML = ""; // Clear previous list
        data.todays_detections.forEach((detection) => {
          const listItem = document.createElement("li");
          listItem.textContent = `${detection.species} - ${detection.confidence} - ${detection.timestamp}`;
          todaysDetectionsList.appendChild(listItem);
        });
      }

      async function loadOverview() {
        const response = await fetch("/overview");
        const data = await response.json();
        const overviewContent = document.getElementById("overviewContent");
        overviewContent.innerHTML = `
          <h3>Disk Usage:</h3>
          <p>Total: ${data.disk_usage.total}</p>
          <p>Used: ${data.disk_usage.used}</p>
          <p>Free: ${data.disk_usage.free}</p>
          <h3>Extra Info:</h3>
          <p>CPU Temperature: ${data.extra_info.cpu_temperature}</p>
          <p>Memory Usage: ${data.extra_info.memory_usage}</p>
          <h3>Total Detections:</h3>
          <p>${data.total_detections}</p>
        `;
      }
    </script>
  </body>
</html>
