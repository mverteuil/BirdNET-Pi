<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BirdNET-Pi YAML Configuration Editor</title>
    <link rel="stylesheet" href="/static/style.css" />
    <!-- CodeMirror CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/monokai.min.css"
    />
    <!-- CodeMirror YAML mode -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/yaml/yaml.min.js"></script>
    <!-- CodeMirror addons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/foldcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/foldgutter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/indent-fold.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/foldgutter.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/search/searchcursor.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/search/search.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/dialog/dialog.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/dialog/dialog.min.css"
    />
    <style>
      .yaml-editor-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      .editor-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      .editor-actions {
        display: flex;
        gap: 10px;
      }
      .editor-wrapper {
        display: flex;
        gap: 20px;
        height: 600px;
      }
      .editor-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      .editor-panel h3 {
        margin: 0 0 10px 0;
      }
      .CodeMirror {
        flex: 1;
        border: 1px solid #ddd;
        font-size: 14px;
      }
      .validation-status {
        margin-top: 10px;
        padding: 10px;
        border-radius: 4px;
      }
      .validation-status.valid {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .validation-status.invalid {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .config-sections {
        margin-bottom: 20px;
      }
      .section-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
      }
      .section-button {
        padding: 5px 10px;
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
      }
      .section-button:hover {
        background-color: #e0e0e0;
      }
      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }
      .btn-primary {
        background-color: #007bff;
        color: white;
      }
      .btn-primary:hover {
        background-color: #0056b3;
      }
      .btn-secondary {
        background-color: #6c757d;
        color: white;
      }
      .btn-secondary:hover {
        background-color: #545b62;
      }
      .btn-success {
        background-color: #28a745;
        color: white;
      }
      .btn-success:hover {
        background-color: #218838;
      }
      @media (max-width: 768px) {
        .editor-wrapper {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <div class="yaml-editor-container">
      <div class="editor-header">
        <h1>Advanced Settings - YAML Editor</h1>
        <div class="editor-actions">
          <button class="btn btn-secondary" onclick="switchToBasicSettings()">
            Basic Settings
          </button>
          <button class="btn btn-secondary" onclick="reloadConfig()">
            Reload
          </button>
          <button class="btn btn-primary" onclick="validateConfig()">
            Validate
          </button>
          <button class="btn btn-success" onclick="saveConfig()">Save</button>
        </div>
      </div>

      <div class="config-sections">
        <h4>Quick Navigation:</h4>
        <div class="section-buttons">
          <button class="section-button" onclick="jumpToSection('site_name')">
            Basic Settings
          </button>
          <button class="section-button" onclick="jumpToSection('model')">
            Model Settings
          </button>
          <button
            class="section-button"
            onclick="jumpToSection('birdweather_id')"
          >
            BirdWeather
          </button>
          <button
            class="section-button"
            onclick="jumpToSection('apprise_input')"
          >
            Notifications
          </button>
          <button class="section-button" onclick="jumpToSection('enable_gps')">
            GPS & Field Mode
          </button>
          <button class="section-button" onclick="jumpToSection('enable_mqtt')">
            MQTT
          </button>
          <button
            class="section-button"
            onclick="jumpToSection('enable_webhooks')"
          >
            Webhooks
          </button>
          <button class="section-button" onclick="jumpToSection('logging')">
            Logging
          </button>
        </div>
      </div>

      <div class="editor-wrapper">
        <div class="editor-panel">
          <h3>Configuration Editor</h3>
          <textarea id="yaml-editor">{{ config_yaml }}</textarea>
          <div id="validation-status" class="validation-status"></div>
        </div>
      </div>
    </div>

    <script>
      let editor;

      // Initialize CodeMirror
      document.addEventListener("DOMContentLoaded", function () {
        editor = CodeMirror.fromTextArea(
          document.getElementById("yaml-editor"),
          {
            mode: "yaml",
            theme: "monokai",
            lineNumbers: true,
            matchBrackets: true,
            foldGutter: true,
            gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
            autoCloseBrackets: true,
            indentUnit: 2,
            tabSize: 2,
            lineWrapping: true,
            extraKeys: {
              "Ctrl-S": function (cm) {
                saveConfig();
              },
              "Cmd-S": function (cm) {
                saveConfig();
              },
              "Ctrl-F": "findPersistent",
            },
          },
        );

        // Auto-validate on change with debounce
        let validateTimeout;
        editor.on("change", function () {
          clearTimeout(validateTimeout);
          validateTimeout = setTimeout(validateConfig, 500);
        });

        // Initial validation
        validateConfig();
      });

      function jumpToSection(sectionName) {
        const content = editor.getValue();
        const lines = content.split("\n");
        for (let i = 0; i < lines.length; i++) {
          if (lines[i].includes(sectionName + ":")) {
            editor.setCursor({ line: i, ch: 0 });
            editor.focus();
            break;
          }
        }
      }

      function validateConfig() {
        const content = editor.getValue();
        const statusDiv = document.getElementById("validation-status");

        fetch("/api/config/validate", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ yaml_content: content }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.valid) {
              statusDiv.className = "validation-status valid";
              statusDiv.textContent = "Configuration is valid";
            } else {
              statusDiv.className = "validation-status invalid";
              statusDiv.innerHTML =
                "<strong>Validation Error:</strong><br>" + data.error;
            }
          })
          .catch((error) => {
            statusDiv.className = "validation-status invalid";
            statusDiv.textContent =
              "Failed to validate configuration: " + error;
          });
      }

      function saveConfig() {
        const content = editor.getValue();

        fetch("/api/config/save", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ yaml_content: content }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert("Configuration saved successfully!");
              validateConfig();
            } else {
              alert("Failed to save configuration: " + data.error);
            }
          })
          .catch((error) => {
            alert("Failed to save configuration: " + error);
          });
      }

      function reloadConfig() {
        if (
          confirm(
            "Are you sure you want to reload? Any unsaved changes will be lost.",
          )
        ) {
          window.location.reload();
        }
      }

      function switchToBasicSettings() {
        window.location.href = "/settings";
      }
    </script>
  </body>
</html>
