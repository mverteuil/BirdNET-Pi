{% extends "base.html.j2" %}

{% block styles %}
    {{ super() }}
    <link rel="stylesheet" href="{{ request.url_for('static', path='css/update.css') }}">
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        // Store configuration for JavaScript
        const deploymentType = "{{ deployment_type }}";
        const sseEndpoint = "{{ sse_endpoint }}";
    </script>
    <script src="{{ request.url_for('static', path='js/update.js') }}"></script>
{% endblock %}

{% block content %}
<div class="update-container">
    <!-- Skip navigation link for screen readers -->
    <a href="#update-content" class="skip-link">{{ _('Skip to update content') }}</a>

    <!-- Deployment Type Banner -->
    <div class="deployment-banner" role="status" aria-live="polite">
        {% if deployment_type == 'docker' %}
            <span class="deployment-badge docker">{{ _('Docker Deployment') }}</span>
        {% elif deployment_type == 'sbc' %}
            <span class="deployment-badge sbc">{{ _('SBC Deployment') }}</span>
        {% else %}
            <span class="deployment-badge unknown">{{ _('Unknown Deployment') }}</span>
        {% endif %}
    </div>

    <!-- Update Status Panel -->
    <div class="update-status-panel" id="update-status-panel" role="region" aria-label="{{ _('Update status') }}">
        <div class="status-header">
            <h2>{{ _('Current Status') }}</h2>
            <button
                type="button"
                id="check-updates-btn"
                class="btn btn-primary"
                aria-label="{{ _('Check for updates') }}"
            >
                <span class="btn-icon" aria-hidden="true">üîÑ</span>
                {{ _('Check for Updates') }}
            </button>
        </div>

        <div class="status-content">
            <div class="status-row">
                <span class="status-label">{{ _('Current Version:') }}</span>
                <span class="status-value" id="current-version">
                    {{ update_status.current_version or _('Unknown') }}
                </span>
            </div>

            <div class="status-row">
                <span class="status-label">{{ _('Latest Version:') }}</span>
                <span class="status-value" id="latest-version">
                    {{ update_status.latest_version or _('Unknown') }}
                </span>
            </div>

            <div class="status-row">
                <span class="status-label">{{ _('Status:') }}</span>
                <span class="status-value" id="update-status">
                    {% if update_status.available %}
                        <span class="badge badge-warning">{{ _('Update Available') }}</span>
                    {% elif update_status.error %}
                        <span class="badge badge-error">{{ _('Error') }}: {{ update_status.error }}</span>
                    {% else %}
                        <span class="badge badge-success">{{ _('Up to Date') }}</span>
                    {% endif %}
                </span>
            </div>
        </div>

        <!-- Update Available Actions -->
        <div id="update-actions" class="update-actions" {% if not update_status.available %}style="display: none;"{% endif %}>
            <h3>{{ _('Update Details') }}</h3>

            {% if update_status.release_notes %}
            <div id="release-notes" class="release-notes">
                {{ update_status.release_notes | safe }}
            </div>
            {% endif %}

            {% if update_status.release_url %}
            <div class="release-link">
                <a href="{{ update_status.release_url }}" target="_blank" rel="noopener noreferrer">
                    {{ _('View on GitHub') }}
                    <span aria-hidden="true">‚ÜóÔ∏è</span>
                </a>
            </div>
            {% endif %}

            {% if deployment_type == 'sbc' and update_status.can_auto_update %}
            <div class="update-buttons">
                <button
                    type="button"
                    id="apply-update-btn"
                    class="btn btn-warning"
                    aria-label="{{ _('Apply update') }}"
                >
                    <span class="btn-icon" aria-hidden="true">‚¨áÔ∏è</span>
                    {{ _('Apply Update') }}
                </button>

                <button
                    type="button"
                    id="test-update-btn"
                    class="btn btn-secondary"
                    aria-label="{{ _('Test update without applying') }}"
                >
                    <span class="btn-icon" aria-hidden="true">üß™</span>
                    {{ _('Test Update (Dry Run)') }}
                </button>
            </div>
            {% elif deployment_type == 'sbc' %}
            <div class="alert alert-info" role="alert">
                <strong>{{ _('Manual Update Required') }}</strong>
                <p>{{ _('This update cannot be applied automatically. Please see instructions below.') }}</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Deployment-Specific Configuration -->
    {% if deployment_type == 'docker' %}
    <!-- Docker Deployment Instructions -->
    <div class="docker-config-panel" id="docker-config-panel" role="region" aria-label="{{ _('Docker update instructions') }}">
        <h2>{{ _('Docker Update Instructions') }}</h2>

        <div class="info-section">
            <p class="info-text">
                {{ _('BirdNET-Pi runs in a Docker container. Updates are managed through Docker image updates.') }}
            </p>
        </div>

        <details class="instructions-details">
            <summary>{{ _('Production Deployment (Tagged Releases)') }}</summary>
            <div class="instructions-content">
                <p>{{ _('For production deployments using tagged releases:') }}</p>
                <ol>
                    <li>{{ _('Stop the current container:') }}
                        <pre><code>docker compose down</code></pre>
                    </li>
                    <li>{{ _('Pull the new image:') }}
                        <pre><code>docker compose pull</code></pre>
                    </li>
                    <li>{{ _('Start the container:') }}
                        <pre><code>docker compose up -d</code></pre>
                    </li>
                    <li>{{ _('Database migrations run automatically on container restart') }}</li>
                </ol>
            </div>
        </details>

        <details class="instructions-details">
            <summary>{{ _('Development Deployment (Latest Code)') }}</summary>
            <div class="instructions-content">
                <p>{{ _('For development deployments building from source:') }}</p>
                <ol>
                    <li>{{ _('Stop the current container:') }}
                        <pre><code>docker compose down</code></pre>
                    </li>
                    <li>{{ _('Rebuild the image:') }}
                        <pre><code>docker compose build</code></pre>
                    </li>
                    <li>{{ _('Start the container:') }}
                        <pre><code>docker compose up -d</code></pre>
                    </li>
                    <li>{{ _('Database migrations run automatically on container restart') }}</li>
                </ol>
            </div>
        </details>

        <div class="alert alert-info" role="alert">
            <strong>{{ _('Note:') }}</strong>
            {{ _('Git remote and branch settings are not used for Docker deployments. Updates come from Docker images.') }}
        </div>
    </div>

    {% elif deployment_type == 'sbc' %}
    <!-- SBC Deployment Git Configuration -->
    <div class="git-config-panel" id="git-config-panel" role="region" aria-label="{{ _('Git configuration') }}">
        <h2>{{ _('Git Configuration') }}</h2>

        <form id="git-config-form" class="git-config-form">
            <div class="config-row">
                <label for="git-remote">{{ _('Git Remote:') }}</label>
                <div class="input-group">
                    <select
                        id="git-remote"
                        name="git_remote"
                        aria-describedby="git-remote-help"
                        data-current-value="{{ git_remote or '' }}"
                        required
                    >
                        <option value="">{{ _('Loading remotes...') }}</option>
                    </select>
                    <button
                        type="button"
                        id="manage-remotes-btn"
                        class="btn btn-secondary"
                        aria-label="{{ _('Manage git remotes') }}"
                    >
                        {{ _('Manage Remotes') }}
                    </button>
                </div>
                <small id="git-remote-help">{{ _('Select the git remote to track for updates') }}</small>
            </div>

            <div class="config-row">
                <label for="git-branch">{{ _('Git Branch/Tag:') }}</label>
                <select
                    id="git-branch"
                    name="git_branch"
                    aria-describedby="git-branch-help"
                    data-current-value="{{ git_branch or '' }}"
                    required
                >
                    <option value="">{{ _('Select a remote first') }}</option>
                </select>
                <small id="git-branch-help">{{ _('Select the branch or tag to track') }}</small>
            </div>

            <div class="config-actions">
                <button
                    type="submit"
                    class="btn btn-primary"
                    aria-label="{{ _('Save git configuration') }}"
                >
                    {{ _('Save Configuration') }}
                </button>
                <div id="git-config-message" class="config-message" role="status" aria-live="polite" style="display: none;"></div>
            </div>
        </form>
    </div>

    <!-- Git Remote Management Modal -->
    <div id="remote-management-modal" class="modal" role="dialog" aria-labelledby="modal-title" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">{{ _('Manage Git Remotes') }}</h3>
                <button
                    type="button"
                    class="modal-close"
                    aria-label="{{ _('Close modal') }}"
                >
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <div class="modal-body">
                <!-- Remote List -->
                <div class="remote-list" id="remote-list" role="list">
                    <!-- Populated by JavaScript -->
                </div>

                <!-- Add New Remote Form -->
                <details class="add-remote-details">
                    <summary>{{ _('Add New Remote') }}</summary>
                    <form id="add-remote-form" class="remote-form">
                        <div class="form-row">
                            <label for="new-remote-name">{{ _('Remote Name:') }}</label>
                            <input
                                type="text"
                                id="new-remote-name"
                                name="name"
                                pattern="[a-zA-Z0-9_-]+"
                                title="{{ _('Letters, numbers, underscore, and dash only') }}"
                                required
                                aria-describedby="remote-name-help"
                            >
                            <small id="remote-name-help">{{ _('e.g., upstream, fork') }}</small>
                        </div>

                        <div class="form-row">
                            <label for="new-remote-url">{{ _('Remote URL:') }}</label>
                            <input
                                type="url"
                                id="new-remote-url"
                                name="url"
                                placeholder="https://github.com/user/repo.git"
                                required
                                aria-describedby="remote-url-help"
                            >
                            <small id="remote-url-help">{{ _('Git repository URL') }}</small>
                        </div>

                        <button type="submit" class="btn btn-primary">
                            {{ _('Add Remote') }}
                        </button>
                    </form>
                </details>
            </div>
        </div>
    </div>

    {% else %}
    <!-- Unknown Deployment Type -->
    <div class="unknown-deployment-panel" role="region" aria-label="{{ _('Unknown deployment information') }}">
        <h2>{{ _('Deployment Type Unknown') }}</h2>
        <div class="alert alert-warning" role="alert">
            <p>{{ _('Unable to determine deployment type. Update functionality may be limited.') }}</p>
        </div>
    </div>
    {% endif %}

    <!-- Update Progress Panel -->
    <div class="update-progress-panel" id="update-progress-panel" style="display: none;"
         role="region" aria-label="{{ _('Update progress') }}" aria-live="polite" aria-atomic="true">
        <h2>{{ _('Update Progress') }}</h2>

        <div class="progress-container">
            <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                <div class="progress-fill" id="progress-fill" style="width: 0%;"></div>
            </div>
            <div class="progress-text" id="progress-text">{{ _('Initializing...') }}</div>
        </div>

        <div class="progress-log" id="progress-log" aria-label="{{ _('Update log') }}">
            <!-- Progress messages will be added here via JavaScript -->
        </div>

        <button
            type="button"
            id="cancel-update-btn"
            class="btn btn-danger"
            aria-label="{{ _('Cancel update') }}"
            style="display: none;"
        >
            <span class="btn-icon" aria-hidden="true">‚ùå</span>
            {{ _('Cancel Update') }}
        </button>
    </div>

    <!-- Last Update Result -->
    {% if update_result %}
    <div class="update-result-panel" id="update-result-panel" role="region" aria-label="{{ _('Last update result') }}">
        <h2>{{ _('Last Update Result') }}</h2>

        <div class="result-content">
            {% if update_result.success %}
                <div class="alert alert-success" role="status">
                    <strong>{{ _('Update Successful') }}</strong>
                    {% if update_result.message %}
                        <p>{{ update_result.message }}</p>
                    {% endif %}
                </div>
            {% else %}
                <div class="alert alert-error" role="alert">
                    <strong>{{ _('Update Failed') }}</strong>
                    {% if update_result.error %}
                        <p>{{ update_result.error }}</p>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Region Pack Management Section -->
    <div class="region-pack-panel" id="region-pack-management" role="region" aria-label="{{ _('Region pack management') }}">
        <h2>{{ _('Region Pack Management') }}</h2>

        <div class="region-pack-status">
            {% set pack_status = get_region_pack_status() %}

            {% if pack_status.has_pack %}
                <div class="status-row">
                    <span class="status-label">{{ _('Installed Packs:') }}</span>
                    <span class="status-value">
                        <span class="badge badge-success">{{ pack_status.pack_count }} {{ _('pack(s) installed') }}</span>
                    </span>
                </div>

                <div class="status-row">
                    <span class="status-label">{{ _('Location:') }}</span>
                    <span class="status-value">
                        {% if pack_status.location_set %}
                            <span class="badge badge-success">{{ _('Configured') }}</span>
                        {% else %}
                            <span class="badge badge-warning">{{ _('Not Set') }}</span>
                        {% endif %}
                    </span>
                </div>
            {% else %}
                <div class="status-message warning">
                    <span class="status-icon" aria-hidden="true">üìç</span>
                    <div>
                        <strong>{{ _('No Region Pack Installed') }}</strong>
                        <p>{{ _('Region packs provide location-specific bird species filtering based on eBird data. Install a pack for your coordinates to enable regional filtering.') }}</p>
                    </div>
                </div>
            {% endif %}

            {% if pack_status.location_set %}
                <div class="region-pack-actions">
                    <button
                        type="button"
                        id="download-region-pack-btn"
                        class="btn btn-primary"
                        aria-label="{{ _('Download region pack for your location') }}"
                    >
                        <span class="btn-icon" aria-hidden="true">üì¶</span>
                        {{ _('Download Region Pack for My Location') }}
                    </button>

                    <p class="help-text">
                        {{ _('This will download the appropriate region pack based on your configured coordinates:') }}
                        <strong>{{ config.latitude }}, {{ config.longitude }}</strong>
                    </p>
                </div>
            {% else %}
                <div class="region-pack-actions">
                    <p class="help-text warning">
                        {{ _('Set your location in') }}
                        <a href="{{ url_for('get_settings_view') }}">{{ _('Settings') }}</a>
                        {{ _('to enable region pack download.') }}
                    </p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Help Section -->
    <div class="help-panel" id="help-panel" role="region" aria-label="{{ _('Update help') }}">
        <h2>{{ _('Update Help') }}</h2>

        {% if deployment_type == 'sbc' %}
        <details>
            <summary>{{ _('About Automatic Updates') }}</summary>
            <div class="help-content">
                <p>{{ _('BirdNET-Pi supports automatic updates on SBC deployments through the update daemon.') }}</p>
                <p>{{ _('The update daemon monitors the configured git remote and branch for new releases.') }}</p>
                <p>{{ _('Before applying an update:') }}</p>
                <ul>
                    <li>{{ _('Ensure your system has sufficient disk space') }}</li>
                    <li>{{ _('Consider backing up your data') }}</li>
                    <li>{{ _('Review the release notes for breaking changes') }}</li>
                </ul>
            </div>
        </details>

        <details>
            <summary>{{ _('SBC Update Process') }}</summary>
            <div class="help-content">
                <p>{{ _('For SBC deployments, updates are performed by the update daemon:') }}</p>
                <ol>
                    <li>{{ _('The daemon checks the configured remote/branch for updates') }}</li>
                    <li>{{ _('If an update is available, it can be applied through the web interface') }}</li>
                    <li>{{ _('The daemon pulls the latest code and runs migrations') }}</li>
                    <li>{{ _('Services are restarted automatically') }}</li>
                </ol>
            </div>
        </details>
        {% elif deployment_type == 'docker' %}
        <details>
            <summary>{{ _('Docker Update Best Practices') }}</summary>
            <div class="help-content">
                <p>{{ _('For Docker deployments:') }}</p>
                <ul>
                    <li>{{ _('Always use docker compose down (never docker compose down -v which deletes data)') }}</li>
                    <li>{{ _('Back up your data volume before major version updates') }}</li>
                    <li>{{ _('Check the release notes on GitHub for breaking changes') }}</li>
                    <li>{{ _('Database migrations run automatically when the container starts') }}</li>
                </ul>
            </div>
        </details>
        {% endif %}

        <details>
            <summary>{{ _('Troubleshooting') }}</summary>
            <div class="help-content">
                <p>{{ _('If you encounter issues:') }}</p>
                <ul>
                    <li>{{ _('Check the system logs for error messages') }}</li>
                    <li>{{ _('Ensure your device has internet connectivity') }}</li>
                    {% if deployment_type == 'sbc' %}
                    <li>{{ _('Verify that the update daemon is running') }}</li>
                    <li>{{ _('Check git remote configuration is correct') }}</li>
                    {% elif deployment_type == 'docker' %}
                    <li>{{ _('Verify Docker daemon is running') }}</li>
                    <li>{{ _('Check Docker image pull permissions') }}</li>
                    {% endif %}
                    <li>{{ _('Report issues on GitHub with error details') }}</li>
                </ul>
            </div>
        </details>
    </div>
</div>

{% endblock %}
