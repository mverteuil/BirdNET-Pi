<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ site_name }} - Automated Bird Detection</title>
    <link rel="icon" type="image/svg+xml" href="/static/images/favicon.svg" />
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <!-- Header Section -->
    <header class="header">
      <div class="header-content">
        <img
          src="/static/images/birdnetpi-icon.png"
          alt="BirdNET-Pi Logo"
          class="logo"
        />
        <h1 class="site-title">{{ site_name }}</h1>
        <p class="tagline">Automated Bird Detection & Monitoring System</p>
      </div>
    </header>

    <!-- Main Content -->
    <main class="container">
      <!-- Dashboard Stats -->
      <section class="dashboard">
        <!-- System Status Card -->
        <div class="card">
          <div class="card-header">
            <div class="card-icon">üü¢</div>
            <h2 class="card-title">System Status</h2>
          </div>
          <div class="card-content">
            <div class="status-indicator status-online" id="system-status">
              <div class="status-dot"></div>
              <span>Online & Monitoring</span>
            </div>
            <div class="mt-2">
              <div>
                CPU Temperature:
                <span id="cpu-temp" class="text-muted">Loading...</span>
              </div>
              <div>
                Memory Usage:
                <span id="memory-usage" class="text-muted">Loading...</span>
              </div>
              <div>
                Disk Space:
                <span id="disk-usage" class="text-muted">Loading...</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Total Detections Card -->
        <div class="card stat-card">
          <div class="card-header">
            <div class="card-icon">ü¶Ö</div>
            <h2 class="card-title">Total Detections</h2>
          </div>
          <div class="card-content">
            <span class="stat-number" id="total-detections">0</span>
            <div class="stat-label">Species Detected</div>
          </div>
        </div>

        <!-- Today's Activity Card -->
        <div class="card stat-card">
          <div class="card-header">
            <div class="card-icon">üìÖ</div>
            <h2 class="card-title">Today's Activity</h2>
          </div>
          <div class="card-content">
            <span class="stat-number" id="todays-count">0</span>
            <div class="stat-label">Detections Today</div>
          </div>
        </div>

        <!-- Audio Stream Status Card -->
        <div class="card">
          <div class="card-header">
            <div class="card-icon">üéµ</div>
            <h2 class="card-title">Audio Stream</h2>
          </div>
          <div class="card-content">
            <div class="audio-visualizer" id="audio-visualizer">
              <!-- Audio level bars will be generated by JavaScript -->
            </div>
            <div class="text-center">
              <div class="status-indicator status-online" id="audio-status">
                <div class="status-dot"></div>
                <span>Streaming</span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Recent Activity Section -->
      <section class="dashboard">
        <!-- Recent Detections Card -->
        <div class="card">
          <div class="card-header">
            <div class="card-icon">üîç</div>
            <h2 class="card-title">Recent Detections</h2>
          </div>
          <div class="card-content">
            <ul class="detection-list" id="recent-detections">
              <li class="detection-item">
                <div>
                  <div class="detection-species">Loading detections...</div>
                </div>
              </li>
            </ul>
          </div>
        </div>

        <!-- Best Recordings Card -->
        <div class="card">
          <div class="card-header">
            <div class="card-icon">‚≠ê</div>
            <h2 class="card-title">Best Recordings</h2>
          </div>
          <div class="card-content">
            <ul class="detection-list" id="best-recordings">
              <li class="detection-item">
                <div>
                  <div class="detection-species">Loading recordings...</div>
                </div>
              </li>
            </ul>
          </div>
        </div>

        <!-- System Health Card -->
        <div class="card">
          <div class="card-header">
            <div class="card-icon">üíª</div>
            <h2 class="card-title">System Health</h2>
          </div>
          <div class="card-content">
            <div class="mb-1">
              <div>CPU Usage</div>
              <div class="progress-bar">
                <div
                  class="progress-fill progress-success"
                  id="cpu-progress"
                  style="width: 0%"
                ></div>
              </div>
            </div>
            <div class="mb-1">
              <div>Memory Usage</div>
              <div class="progress-bar">
                <div
                  class="progress-fill progress-warning"
                  id="memory-progress"
                  style="width: 0%"
                ></div>
              </div>
            </div>
            <div>
              <div>Disk Usage</div>
              <div class="progress-bar">
                <div
                  class="progress-fill progress-success"
                  id="disk-progress"
                  style="width: 0%"
                ></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Navigation Section -->
      <section class="nav-grid">
        <a href="/reports/todays_detections" class="nav-button">
          <div class="nav-icon">üìä</div>
          <span>View Detections</span>
        </a>
        <a href="/reports/best_recordings" class="nav-button">
          <div class="nav-icon">üéß</div>
          <span>Best Recordings</span>
        </a>
        <a href="/spectrogram" class="nav-button">
          <div class="nav-icon">üìà</div>
          <span>Live Spectrogram</span>
        </a>
        <a href="/reports/charts" class="nav-button">
          <div class="nav-icon">üìâ</div>
          <span>Reports & Charts</span>
        </a>
        <a href="/field_mode" class="nav-button">
          <div class="nav-icon">üó∫Ô∏è</div>
          <span>Field Mode</span>
        </a>
        <a href="/settings" class="nav-button">
          <div class="nav-icon">‚öôÔ∏è</div>
          <span>Settings</span>
        </a>
      </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
      <div class="container">
        <p>
          &copy; 2024 BirdNET-Pi | Version 2.4 | Last updated:
          <span id="last-updated">Loading...</span>
        </p>
      </div>
    </footer>

    <!-- JavaScript -->
    <script>
      // WebSocket connection for real-time updates
      let ws;
      let reconnectInterval = 5000;

      function connectWebSocket() {
        try {
          ws = new WebSocket("{{ websocket_url }}");

          ws.onopen = function () {
            console.log("WebSocket connected");
            updateConnectionStatus(true);
          };

          ws.onmessage = function (event) {
            try {
              const data = JSON.parse(event.data);
              handleWebSocketMessage(data);
            } catch (e) {
              console.log("Received non-JSON message:", event.data);
            }
          };

          ws.onclose = function () {
            console.log("WebSocket disconnected");
            updateConnectionStatus(false);
            // Reconnect after delay
            setTimeout(connectWebSocket, reconnectInterval);
          };

          ws.onerror = function (error) {
            console.error("WebSocket error:", error);
            updateConnectionStatus(false);
          };
        } catch (error) {
          console.error("Failed to connect WebSocket:", error);
          updateConnectionStatus(false);
          setTimeout(connectWebSocket, reconnectInterval);
        }
      }

      function handleWebSocketMessage(data) {
        // Handle different types of WebSocket messages
        if (data.type === "detection") {
          updateRecentDetections(data);
        } else if (data.type === "system_stats") {
          updateSystemStats(data);
        }
      }

      function updateConnectionStatus(connected) {
        const systemStatus = document.getElementById("system-status");
        const audioStatus = document.getElementById("audio-status");

        if (connected) {
          systemStatus.className = "status-indicator status-online";
          systemStatus.innerHTML =
            '<div class="status-dot"></div><span>Online & Monitoring</span>';
          audioStatus.className = "status-indicator status-online";
          audioStatus.innerHTML =
            '<div class="status-dot"></div><span>Streaming</span>';
        } else {
          systemStatus.className = "status-indicator status-offline";
          systemStatus.innerHTML =
            '<div class="status-dot"></div><span>Offline</span>';
          audioStatus.className = "status-indicator status-offline";
          audioStatus.innerHTML =
            '<div class="status-dot"></div><span>Disconnected</span>';
        }
      }

      // Initialize audio visualizer
      function initAudioVisualizer() {
        const visualizer = document.getElementById("audio-visualizer");
        for (let i = 0; i < 20; i++) {
          const bar = document.createElement("div");
          bar.className = "audio-bar";
          bar.style.height = Math.random() * 60 + 10 + "px";
          visualizer.appendChild(bar);
        }

        // Animate bars
        setInterval(() => {
          const bars = visualizer.querySelectorAll(".audio-bar");
          bars.forEach((bar) => {
            bar.style.height = Math.random() * 60 + 10 + "px";
          });
        }, 200);
      }

      // Load dashboard data
      async function loadDashboardData() {
        try {
          // Load overview data
          const overviewResponse = await fetch("/api/system/overview");
          if (overviewResponse.ok) {
            const overviewData = await overviewResponse.json();
            updateOverviewData(overviewData);
          }

          // Load today's detections
          const detectionsResponse = await fetch("/reports/todays_detections");
          if (detectionsResponse.ok) {
            const detectionsData = await detectionsResponse.json();
            updateTodaysDetections(detectionsData);
          }

          // Load best recordings
          const recordingsResponse = await fetch("/reports/best_recordings");
          if (recordingsResponse.ok) {
            const recordingsData = await recordingsResponse.json();
            updateBestRecordings(recordingsData);
          }
        } catch (error) {
          console.error("Error loading dashboard data:", error);
        }
      }

      function updateOverviewData(data) {
        // Update total detections
        document.getElementById("total-detections").textContent =
          data.total_detections || 0;

        // Update system stats
        if (data.extra_info) {
          document.getElementById("cpu-temp").textContent =
            data.extra_info.cpu_temperature || "N/A";
          document.getElementById("memory-usage").textContent =
            data.extra_info.memory_usage || "N/A";
        }

        if (data.disk_usage) {
          document.getElementById("disk-usage").textContent =
            `${data.disk_usage.used} / ${data.disk_usage.total}`;

          // Update progress bars (simplified - you might want to parse actual percentages)
          const diskPercent = 45; // This would need actual calculation
          const memoryPercent = 60;
          const cpuPercent = 30;

          document.getElementById("disk-progress").style.width =
            diskPercent + "%";
          document.getElementById("memory-progress").style.width =
            memoryPercent + "%";
          document.getElementById("cpu-progress").style.width =
            cpuPercent + "%";
        }
      }

      function updateTodaysDetections(data) {
        const container = document.getElementById("recent-detections");
        const todaysCount = document.getElementById("todays-count");

        if (data.todays_detections && data.todays_detections.length > 0) {
          todaysCount.textContent = data.todays_detections.length;

          container.innerHTML = "";
          data.todays_detections.slice(0, 5).forEach((detection) => {
            const item = document.createElement("li");
            item.className = "detection-item";
            item.innerHTML = `
              <div>
                <div class="detection-species">${detection.species}</div>
                <div class="detection-time">${new Date(detection.timestamp).toLocaleTimeString()}</div>
              </div>
              <div class="detection-confidence">${(detection.confidence * 100).toFixed(1)}%</div>
            `;
            container.appendChild(item);
          });
        } else {
          todaysCount.textContent = "0";
          container.innerHTML =
            '<li class="detection-item"><div class="detection-species text-muted">No detections today</div></li>';
        }
      }

      function updateBestRecordings(data) {
        const container = document.getElementById("best-recordings");

        if (data.best_recordings && data.best_recordings.length > 0) {
          container.innerHTML = "";
          data.best_recordings.slice(0, 3).forEach((recording) => {
            const item = document.createElement("li");
            item.className = "detection-item";
            item.innerHTML = `
              <div>
                <div class="detection-species">${recording.species}</div>
                <div class="detection-time">${new Date(recording.timestamp).toLocaleString()}</div>
              </div>
              <div class="detection-confidence">${(recording.confidence * 100).toFixed(1)}%</div>
            `;
            container.appendChild(item);
          });
        } else {
          container.innerHTML =
            '<li class="detection-item"><div class="detection-species text-muted">No recordings available</div></li>';
        }
      }

      // Update last updated timestamp
      function updateLastUpdated() {
        document.getElementById("last-updated").textContent =
          new Date().toLocaleString();
      }

      // Initialize everything when page loads
      document.addEventListener("DOMContentLoaded", function () {
        initAudioVisualizer();
        loadDashboardData();
        connectWebSocket();
        updateLastUpdated();

        // Refresh data every 30 seconds
        setInterval(loadDashboardData, 30000);
        setInterval(updateLastUpdated, 60000);
      });
    </script>
  </body>
</html>
