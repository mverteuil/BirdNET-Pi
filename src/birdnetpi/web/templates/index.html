<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BirdNET-Pi - AI-Powered Bird Detection System</title>
    <link rel="icon" type="image/svg+xml" href="/static/images/favicon.svg" />
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Hero Section -->
    <section class="hero">
      <div class="hero-bg-pattern"></div>
      <div class="hero-bird-bg"></div>
      <div class="hero-container">
        <div class="hero-content">
          <h1 class="hero-title">BirdNET-Pi</h1>
          <p class="hero-subtitle">
            AI-powered bird detection and monitoring system running 24/7 on your
            Raspberry Pi
          </p>
          <div class="hero-cta">
            <button
              class="btn btn-primary"
              onclick="scrollToSection('dashboard')"
            >
              <span>üéØ</span> View Dashboard
            </button>
            <a href="/reports/detections" class="btn btn-secondary">
              <span>üìä</span> Browse Detections
            </a>
            <button
              class="btn btn-secondary"
              onclick="toastManager.showAllIconsTest()"
              style="font-size: 0.9rem"
            >
              üß™ Test Icons
            </button>
          </div>
          <div class="hero-stats">
            <div class="stat-item">
              <span class="stat-value" id="total-species">0</span>
              <span class="stat-label">Species Detected</span>
            </div>
            <div class="stat-item">
              <span class="stat-value" id="today-detections">0</span>
              <span class="stat-label">Today's Detections</span>
            </div>
            <div class="stat-item">
              <span class="stat-value" id="recording-hours">0</span>
              <span class="stat-label">Hours Recorded</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Dashboard Section -->
    <section class="dashboard" id="dashboard">
      <div class="section-header">
        <h2 class="section-title">Live Dashboard</h2>
        <p class="section-subtitle">
          Real-time bird detection and system monitoring
        </p>
      </div>

      <!-- Quick Actions at Top -->
      <div class="actions-grid">
        <a href="/reports/detections" class="action-card">
          <div class="action-icon">üîç</div>
          <div class="action-title">All Detections</div>
          <div class="action-description">
            Browse complete detection history
          </div>
        </a>
        <a href="/reports/best" class="action-card">
          <div class="action-icon">‚≠ê</div>
          <div class="action-title">Best Recordings</div>
          <div class="action-description">
            Listen to high-confidence detections
          </div>
        </a>
        <a href="/spectrogram" class="action-card">
          <div class="action-icon">üìä</div>
          <div class="action-title">Live Spectrogram</div>
          <div class="action-description">Visualize audio frequencies</div>
        </a>
        <a href="/reports" class="action-card">
          <div class="action-icon">üìà</div>
          <div class="action-title">Reports</div>
          <div class="action-description">Analyze detection patterns</div>
        </a>
        <a href="/field" class="action-card">
          <div class="action-icon">üé§</div>
          <div class="action-title">Field Mode</div>
          <div class="action-description">Manual recording mode</div>
        </a>
        <a href="/admin/settings" class="action-card">
          <div class="action-icon">‚öôÔ∏è</div>
          <div class="action-title">Settings</div>
          <div class="action-description">Configure your system</div>
        </a>
      </div>

      <div class="dashboard-grid">
        <!-- System Status Card -->
        <div class="dashboard-card">
          <div class="card-header">
            <h3 class="card-title">System Status</h3>
            <span class="status-indicator status-online" id="system-status">
              <span class="pulse-dot"></span>
              <span>Online</span>
            </span>
          </div>
          <div class="system-grid">
            <div class="system-metric">
              <div class="metric-label">CPU Usage</div>
              <div class="metric-value" id="cpu-usage">0%</div>
              <div class="progress-bar">
                <div
                  class="progress-fill"
                  id="cpu-progress"
                  style="width: 0%"
                ></div>
              </div>
            </div>
            <div class="system-metric">
              <div class="metric-label">Memory</div>
              <div class="metric-value" id="memory-usage">0%</div>
              <div class="progress-bar">
                <div
                  class="progress-fill"
                  id="memory-progress"
                  style="width: 0%"
                ></div>
              </div>
            </div>
            <div class="system-metric">
              <div class="metric-label">Disk Space</div>
              <div class="metric-value" id="disk-usage">0%</div>
              <div class="progress-bar">
                <div
                  class="progress-fill"
                  id="disk-progress"
                  style="width: 0%"
                ></div>
              </div>
            </div>
            <div class="system-metric">
              <div class="metric-label">Temperature</div>
              <div class="metric-value" id="cpu-temp">0¬∞C</div>
            </div>
          </div>
        </div>

        <!-- Recent Detections Card -->
        <div class="dashboard-card">
          <div class="card-header">
            <h3 class="card-title">Recent Detections</h3>
            <span class="card-badge badge-success" id="detection-count"
              >0 today</span
            >
          </div>
          <div class="detection-feed" id="detection-feed">
            <div
              class="detection-item skeleton"
              style="height: 60px; border-radius: 10px"
            ></div>
            <div
              class="detection-item skeleton"
              style="height: 60px; border-radius: 10px"
            ></div>
            <div
              class="detection-item skeleton"
              style="height: 60px; border-radius: 10px"
            ></div>
          </div>
        </div>

        <!-- Audio Stream Card -->
        <div class="dashboard-card">
          <div class="card-header">
            <h3 class="card-title">Audio Stream</h3>
            <span class="status-indicator status-offline" id="audio-status">
              <span class="pulse-dot"></span>
              <span>Connecting...</span>
            </span>
          </div>
          <div class="audio-visualizer-container">
            <div class="audio-visualizer" id="audio-visualizer">
              <!-- Bars will be generated by JavaScript -->
            </div>
            <div style="text-align: center; margin-top: 1rem">
              <span style="color: var(--text-secondary); font-size: 0.9rem"
                >Live Audio Analysis</span
              >
            </div>
          </div>
        </div>
      </div>
    </section>

    <script>
      // WebSocket connection
      let ws = null;
      let reconnectTimer = null;
      let audioAnimationFrame = null;
      let toastQueue = [];
      let isShowingToast = false;

      // Toast Notification System
      class ToastManager {
        constructor() {
          this.container = document.getElementById("toast-container");
          this.toastHistory = new Set();
        }

        show(type, title, message, details = {}) {
          const toast = document.createElement("div");
          toast.className = `toast ${this.getToastClass(type)}`;

          const iconClass = this.getIconClass(type);
          const detailsHtml = this.formatDetails(details);

          toast.innerHTML = `
          <div class="toast-icon ${iconClass}"></div>
          <div class="toast-content">
            <div class="toast-title">${title}</div>
            <div class="toast-message">${message}</div>
            ${detailsHtml ? `<div class="toast-details">${detailsHtml}</div>` : ""}
          </div>
          <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
        `;

          this.container.appendChild(toast);

          // Auto-hide after 8 seconds for most, 15 seconds for errors
          const duration = type.includes("error") ? 15000 : 8000;
          setTimeout(() => {
            toast.classList.add("hiding");
            setTimeout(() => toast.remove(), 300);
          }, duration);
        }

        getToastClass(type) {
          if (type.includes("error")) return "toast-error";
          if (type.includes("warning")) return "toast-warning";
          if (type.includes("update") || type.includes("available"))
            return "toast-info";
          return "toast-success";
        }

        getIconClass(type) {
          const iconMap = {
            "new-detection": "new-detection",
            "first-ever": "first-ever",
            "first-today": "first-today",
            "first-week": "first-week",
            "first-month": "first-month",
            "first-genus": "first-genus",
            "first-family": "first-family",
            "system-update": "system-update",
            "system-error": "system-error",
            "system-warning": "system-warning",
            "no-audio": "no-audio",
            "update-available": "update-available",
            "filter-mode": "filter-mode",
          };
          return iconMap[type] || "new-detection";
        }

        formatDetails(details) {
          const parts = [];
          if (details.time)
            parts.push(`<span class="toast-detail">üïê ${details.time}</span>`);
          if (details.confidence)
            parts.push(
              `<span class="toast-detail">üìä ${details.confidence}</span>`,
            );
          if (details.location)
            parts.push(
              `<span class="toast-detail">üìç ${details.location}</span>`,
            );
          if (details.version)
            parts.push(
              `<span class="toast-detail">üì¶ ${details.version}</span>`,
            );
          if (details.count)
            parts.push(`<span class="toast-detail">üî¢ ${details.count}</span>`);
          return parts.join("");
        }

        // Debug method to test all icons
        showAllIconsTest() {
          const iconTypes = [
            "new-detection",
            "first-ever",
            "first-today",
            "first-week",
            "first-month",
            "first-genus",
            "first-family",
            "system-update",
            "system-error",
            "system-warning",
            "no-audio",
            "update-available",
            "filter-mode",
          ];

          iconTypes.forEach((type, index) => {
            setTimeout(() => {
              this.show(
                type,
                `Icon Test ${index + 1}`,
                `Testing ${type} icon`,
                { time: new Date().toLocaleTimeString() },
              );
            }, index * 500);
          });
        }

        // Simulate different notification types
        simulateNotifications() {
          const notifications = [
            {
              type: "new-detection",
              title: "New Detection",
              message: "American Robin detected with high confidence",
              details: {
                time: new Date().toLocaleTimeString(),
                confidence: "94.7%",
                location: "Backyard Mic",
              },
            },
            {
              type: "first-ever",
              title: "First Ever Detection! üéâ",
              message:
                "Northern Cardinal - This is the first time this species has been detected by your system",
              details: {
                time: new Date().toLocaleTimeString(),
                confidence: "98.2%",
                count: "1st detection",
              },
            },
            {
              type: "first-today",
              title: "First Detection Today",
              message: "Blue Jay - First detection of this species today",
              details: {
                time: new Date().toLocaleTimeString(),
                confidence: "87.5%",
              },
            },
            {
              type: "first-week",
              title: "First This Week",
              message: "House Sparrow - First detection this week after 6 days",
              details: {
                time: new Date().toLocaleTimeString(),
                confidence: "91.3%",
                count: "Last seen: 6 days ago",
              },
            },
            {
              type: "first-month",
              title: "First This Month",
              message:
                "Red-tailed Hawk - Welcome back! First detection this month",
              details: {
                time: new Date().toLocaleTimeString(),
                confidence: "85.9%",
              },
            },
            {
              type: "first-genus",
              title: "New Genus Detected! ü¶Ö",
              message:
                "Genus: Buteo (Hawks) - First detection of this genus group",
              details: {
                time: new Date().toLocaleTimeString(),
                count: "Species: Red-tailed Hawk",
              },
            },
            {
              type: "first-family",
              title: "New Bird Family! ü¶ú",
              message:
                "Family: Psittacidae (Parrots) - First detection from this family",
              details: {
                time: new Date().toLocaleTimeString(),
                count: "Species: Monk Parakeet",
              },
            },
            {
              type: "system-update",
              title: "System Updated",
              message: "BirdNET-Pi has been successfully updated",
              details: {
                version: "v2.4.1",
                time: new Date().toLocaleTimeString(),
              },
            },
            {
              type: "system-error",
              title: "System Error",
              message:
                "Audio processing failed - Unable to analyze audio stream",
              details: {
                time: new Date().toLocaleTimeString(),
                location: "Error Code: AUD_PROC_001",
              },
            },
            {
              type: "system-warning",
              title: "System Warning",
              message: "Disk space running low - Only 2.3 GB remaining",
              details: {
                time: new Date().toLocaleTimeString(),
                count: "89% used",
              },
            },
            {
              type: "no-audio",
              title: "No Audio Detected",
              message:
                "Audio input not detected for 5 minutes - Check microphone connection",
              details: {
                time: new Date().toLocaleTimeString(),
                location: "Device: USB Audio Device",
              },
            },
            {
              type: "update-available",
              title: "Update Available",
              message:
                "New BirdNET-Pi version available with improved detection accuracy",
              details: {
                version: "v2.5.0",
                count: "15 improvements",
              },
            },
            {
              type: "filter-mode",
              title: "Filter Mode Changed",
              message: "Switching to nocturnal species detection mode",
              details: {
                time: new Date().toLocaleTimeString(),
                location: "Active: 8PM - 6AM",
              },
            },
          ];

          // Show a random notification every 10 seconds for demo
          let index = 0;
          setInterval(() => {
            const notification = notifications[index % notifications.length];
            this.show(
              notification.type,
              notification.title,
              notification.message,
              notification.details,
            );
            index++;
          }, 10000);

          // Show first notification immediately
          const firstNotification = notifications[0];
          setTimeout(() => {
            this.show(
              firstNotification.type,
              firstNotification.title,
              firstNotification.message,
              firstNotification.details,
            );
          }, 2000);
        }
      }

      const toastManager = new ToastManager();

      // Initialize audio visualizer
      function initAudioVisualizer() {
        const visualizer = document.getElementById("audio-visualizer");
        visualizer.innerHTML = "";

        for (let i = 0; i < 32; i++) {
          const bar = document.createElement("div");
          bar.className = "audio-bar";
          bar.style.height = "10px";
          visualizer.appendChild(bar);
        }

        animateAudioBars();
      }

      // Animate audio bars
      function animateAudioBars() {
        const bars = document.querySelectorAll(".audio-bar");
        bars.forEach((bar) => {
          const height = Math.random() * 80 + 20;
          bar.style.height = height + "px";
        });

        audioAnimationFrame = requestAnimationFrame(() => {
          setTimeout(animateAudioBars, 100);
        });
      }

      // Connect to WebSocket
      function connectWebSocket() {
        const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        const wsUrl = `${protocol}//${window.location.host}/ws`;

        try {
          ws = new WebSocket(wsUrl);

          ws.onopen = () => {
            console.log("WebSocket connected");
            updateConnectionStatus(true);
            clearTimeout(reconnectTimer);
          };

          ws.onmessage = (event) => {
            try {
              const data = JSON.parse(event.data);
              handleWebSocketMessage(data);
            } catch (e) {
              console.log("Received:", event.data);
            }
          };

          ws.onclose = () => {
            console.log("WebSocket disconnected");
            updateConnectionStatus(false);
            scheduleReconnect();
          };

          ws.onerror = (error) => {
            console.error("WebSocket error:", error);
            updateConnectionStatus(false);
          };
        } catch (error) {
          console.error("Failed to connect WebSocket:", error);
          scheduleReconnect();
        }
      }

      // Schedule reconnection
      function scheduleReconnect() {
        clearTimeout(reconnectTimer);
        reconnectTimer = setTimeout(connectWebSocket, 5000);
      }

      // Update connection status
      function updateConnectionStatus(connected) {
        const systemStatus = document.getElementById("system-status");
        const audioStatus = document.getElementById("audio-status");

        if (connected) {
          systemStatus.className = "status-indicator status-online";
          systemStatus.innerHTML =
            '<span class="pulse-dot"></span><span>Online</span>';
          audioStatus.className = "status-indicator status-online";
          audioStatus.innerHTML =
            '<span class="pulse-dot"></span><span>Streaming</span>';
        } else {
          systemStatus.className = "status-indicator status-offline";
          systemStatus.innerHTML =
            '<span class="pulse-dot"></span><span>Offline</span>';
          audioStatus.className = "status-indicator status-offline";
          audioStatus.innerHTML =
            '<span class="pulse-dot"></span><span>Disconnected</span>';
        }
      }

      // Handle WebSocket messages
      function handleWebSocketMessage(data) {
        if (data.type === "detection") {
          updateDetectionFeed(data);

          // Show toast notification for detection
          const confidence = Math.round(data.confidence * 100);
          const time = new Date().toLocaleTimeString();

          // Check if it's a special detection (first ever, first today, etc.)
          if (data.is_first_ever) {
            toastManager.show(
              "first-ever",
              "First Ever Detection! üéâ",
              `${data.species} - This is the first time this species has been detected`,
              { time, confidence: `${confidence}%` },
            );
          } else if (data.is_first_today) {
            toastManager.show(
              "first-today",
              "First Detection Today",
              `${data.species} - First detection of this species today`,
              { time, confidence: `${confidence}%` },
            );
          } else if (confidence > 90) {
            toastManager.show(
              "new-detection",
              "High Confidence Detection",
              `${data.species} detected with high confidence`,
              { time, confidence: `${confidence}%` },
            );
          }
        } else if (data.type === "system_stats") {
          updateSystemStats(data);

          // Check for warnings
          if (data.disk_usage > 85) {
            toastManager.show(
              "system-warning",
              "Disk Space Warning",
              `Disk usage at ${data.disk_usage}% - Consider freeing up space`,
              { time: new Date().toLocaleTimeString() },
            );
          }
        } else if (data.type === "system_error") {
          toastManager.show(
            "system-error",
            "System Error",
            data.message || "An error occurred in the system",
            { time: new Date().toLocaleTimeString() },
          );
        } else if (data.type === "no_audio") {
          toastManager.show(
            "no-audio",
            "No Audio Detected",
            "Audio input not detected - Check microphone connection",
            { time: new Date().toLocaleTimeString() },
          );
        }
      }

      // Update detection feed
      function updateDetectionFeed(detection) {
        const feed = document.getElementById("detection-feed");

        // Create new detection item
        const item = document.createElement("div");
        item.className = "detection-item";
        item.style.opacity = "0";
        item.innerHTML = `
        <div class="detection-info">
          <div class="detection-species">${detection.species || "Unknown"}</div>
          <div class="detection-time">${new Date().toLocaleTimeString()}</div>
        </div>
        <div class="detection-confidence">${Math.round(detection.confidence * 100)}%</div>
      `;

        // Add to feed
        feed.insertBefore(item, feed.firstChild);

        // Animate in
        setTimeout(() => {
          item.style.opacity = "1";
        }, 10);

        // Remove old items
        while (feed.children.length > 5) {
          feed.removeChild(feed.lastChild);
        }

        // Update latest detection in hero
        document.getElementById("latest-bird").textContent =
          detection.species || "Unknown";
        document.getElementById("latest-confidence").textContent =
          Math.round(detection.confidence * 100) + "%";
      }

      // Update system stats
      function updateSystemStats(stats) {
        if (stats.cpu_usage !== undefined) {
          document.getElementById("cpu-usage").textContent =
            Math.round(stats.cpu_usage) + "%";
          document.getElementById("cpu-progress").style.width =
            stats.cpu_usage + "%";
        }

        if (stats.memory_usage !== undefined) {
          document.getElementById("memory-usage").textContent =
            Math.round(stats.memory_usage) + "%";
          document.getElementById("memory-progress").style.width =
            stats.memory_usage + "%";
        }

        if (stats.disk_usage !== undefined) {
          document.getElementById("disk-usage").textContent =
            Math.round(stats.disk_usage) + "%";
          document.getElementById("disk-progress").style.width =
            stats.disk_usage + "%";
        }

        if (stats.cpu_temp !== undefined) {
          document.getElementById("cpu-temp").textContent =
            Math.round(stats.cpu_temp) + "¬∞C";
        }
      }

      // Load initial data from API
      async function loadDashboardData() {
        try {
          // Load system overview
          const overviewResponse = await fetch("/api/system/overview");
          if (overviewResponse.ok) {
            const data = await overviewResponse.json();

            // Update stats
            if (data.total_detections) {
              document.getElementById("total-species").textContent =
                data.total_detections;
            }

            // Update system info
            if (data.extra_info) {
              if (data.extra_info.cpu_temperature) {
                document.getElementById("cpu-temp").textContent =
                  data.extra_info.cpu_temperature;
              }
            }

            if (data.disk_usage) {
              const used = parseFloat(data.disk_usage.used);
              const total = parseFloat(data.disk_usage.total);
              const percent = ((used / total) * 100).toFixed(1);
              document.getElementById("disk-usage").textContent = percent + "%";
              document.getElementById("disk-progress").style.width =
                percent + "%";
            }
          }

          // Load today's detections
          const todayResponse = await fetch("/reports/today");
          if (todayResponse.ok) {
            const data = await todayResponse.json();

            if (data.todays_detections) {
              const count = data.todays_detections.length;
              document.getElementById("today-detections").textContent = count;
              document.getElementById("detection-count").textContent =
                count + " today";

              // Update detection feed
              const feed = document.getElementById("detection-feed");
              feed.innerHTML = "";

              if (count > 0) {
                data.todays_detections.slice(0, 5).forEach((detection) => {
                  const item = document.createElement("div");
                  item.className = "detection-item";
                  item.innerHTML = `
                  <div class="detection-info">
                    <div class="detection-species">${detection.species}</div>
                    <div class="detection-time">${new Date(detection.timestamp).toLocaleTimeString()}</div>
                  </div>
                  <div class="detection-confidence">${Math.round(detection.confidence * 100)}%</div>
                `;
                  feed.appendChild(item);
                });

                // Update latest detection
                const latest = data.todays_detections[0];
                if (latest) {
                  document.getElementById("latest-bird").textContent =
                    latest.species;
                  document.getElementById("latest-confidence").textContent =
                    Math.round(latest.confidence * 100) + "%";
                }
              } else {
                feed.innerHTML =
                  '<div style="text-align: center; color: var(--text-secondary); padding: 2rem;">No detections today</div>';
              }
            }
          }

          // Calculate recording hours (mock data for now)
          const hours = Math.floor(Math.random() * 100) + 24;
          document.getElementById("recording-hours").textContent = hours;
        } catch (error) {
          console.error("Error loading dashboard data:", error);
        }
      }

      // Smooth scroll to section
      function scrollToSection(id) {
        document.getElementById(id).scrollIntoView({ behavior: "smooth" });
      }

      // Animate numbers on scroll
      function animateNumbers() {
        const observer = new IntersectionObserver((entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              const target = entry.target;
              const final = parseInt(target.textContent);
              let current = 0;
              const increment = final / 50;

              const timer = setInterval(() => {
                current += increment;
                if (current >= final) {
                  target.textContent = final;
                  clearInterval(timer);
                } else {
                  target.textContent = Math.floor(current);
                }
              }, 30);

              observer.unobserve(target);
            }
          });
        });

        document.querySelectorAll(".stat-value").forEach((el) => {
          observer.observe(el);
        });
      }

      // Initialize on page load
      document.addEventListener("DOMContentLoaded", () => {
        initAudioVisualizer();
        connectWebSocket();
        loadDashboardData();
        animateNumbers();

        // Start toast notification demo (remove in production)
        toastManager.simulateNotifications();

        // Refresh data periodically
        setInterval(loadDashboardData, 30000);
      });

      // Cleanup on page unload
      window.addEventListener("beforeunload", () => {
        if (ws) {
          ws.close();
        }
        if (audioAnimationFrame) {
          cancelAnimationFrame(audioAnimationFrame);
        }
      });
    </script>
  </body>
</html>
