{% extends "base.html.j2" %}
{% set page_name = 'Detections' %}
{% set active_page = 'detections' %}

{% block styles %}
    {{ super() }}
    <link rel="stylesheet" href="{{ request.url_for('static', path='css/period_selector.css') }}" />
    <link rel="stylesheet" href="{{ request.url_for('static', path='css/all_detections.css') }}" />
    <link rel="stylesheet" href="{{ request.url_for('static', path='css/taxonomy_display.css') }}" />
    <link rel="stylesheet" href="{{ request.url_for('static', path='css/taxonomic_filters.css') }}" />
    <link rel="stylesheet" href="{{ request.url_for('static', path='css/pagination.css') }}" />
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="{{ request.url_for('static', path='js/period_selector.js') }}"></script>
    <script src="{{ request.url_for('static', path='js/pagination.js') }}"></script>
    <script src="{{ request.url_for('static', path='js/taxonomic_filters.js') }}"></script>
    <script src="{{ request.url_for('static', path='js/taxonomy_display.js') }}"></script>
    <script src="{{ request.url_for('static', path='js/all_detections.js') }}"></script>
{% endblock %}

{% block content %}

    <!-- Subtitle info (kept below navigation) -->
    <p class="subtitle" role="status" aria-live="polite"><span id="species-count">0</span> {{ _('species active') }} · <span id="total-detection-count">0</span> {{ _('detections') }}</p>

    <!-- Time period selector -->
    {% set id = 'detections-period' %}
    {% set initial_period = period|default('day') %}
    {% set onchange_callback = 'onDetectionsPeriodChange' %}
    {% set show_historical = false %}
    {% include 'components/period_selector.html.j2' %}

    <!-- Taxonomic filters (without confidence filter) -->
    {% set show_confidence = false %}
    {% include 'components/taxonomic_filters.html.j2' with context %}

    <!-- Main content grid -->
    <div class="main-content">
        <!-- Detections timeline -->
        <div class="timeline">
            <div class="timeline-header">
                {{ _('All Detections') }}
            </div>
            <table class="data-table" id="detections-table">
                <thead>
                    <tr>
                        <th class="sortable" data-sort="timestamp" onclick="sortDetections('timestamp')">{{ _('Time') }}</th>
                        <th class="sortable" data-sort="species" onclick="sortDetections('species')">{{ _('Species') }}</th>
                        <th>{{ _('Date') }}</th>
                        <th class="sortable text-right" data-sort="confidence" onclick="sortDetections('confidence')">{{ _('Confidence') }}</th>
                        <th class="sortable text-center" data-sort="first" onclick="sortDetections('first')">★|●</th>
                    </tr>
                </thead>
                <tbody id="detections-list">
                    <tr><td colspan="5" class="no-data">{{ _('Loading detections...') }}</td></tr>
                </tbody>
            </table>
            <div id="pagination" class="pagination">
                <!-- Pagination controls will be added here -->
            </div>
        </div>

        <!-- Species frequency table -->
        <div>
            <table class="data-table" id="species-frequency-table">
                <thead>
                    <tr>
                        <th class="sortable" data-sort="name" onclick="sortSpeciesTable('name')">{{ _('Species') }}</th>
                        <th class="sortable text-center" data-sort="first_detection" onclick="sortSpeciesTable('first_detection')">★</th>
                        <th class="sortable text-right" id="count-header" data-sort="count" onclick="sortSpeciesTable('count')">
                            {% if period == 'day' %}{{ _('Today') }}
                            {% elif period == 'week' %}{{ _('This Week') }}
                            {% elif period == 'month' %}{{ _('This Month') }}
                            {% elif period == 'season' %}{{ _('This Season') }}
                            {% elif period == 'year' %}{{ _('This Year') }}
                            {% else %}{{ _('All Time') }}
                            {% endif %}
                        </th>
                    </tr>
                </thead>
                <tbody id="species-frequency-tbody">
                    <tr><td colspan="3" class="no-data">{{ _('Loading species...') }}</td></tr>
                </tbody>
            </table>
            <!-- Species table pagination matching detections style -->
            <div id="species-pagination" class="pagination">
                <!-- Pagination controls will be added here by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Date picker modal -->
    <div id="date-picker-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>{{ _('Select Date') }}</h3>
            <input type="date" id="date-input" />
            <div class="modal-buttons">
                <button onclick="goToSelectedDate()">{{ _('Go') }}</button>
                <button onclick="closeDatePicker()">{{ _('Cancel') }}</button>
            </div>
        </div>
    </div>

    <!-- Hidden HTML Templates for JavaScript (for i18n) -->
    <div id="js-templates" style="display: none;">
        <!-- Detection entry template for new detections via SSE -->
        <template id="detection-entry-template">
            <div class="detection-entry new-detection" data-species="">
                <button class="play-button" data-action="play" title="{{ _('Play recording') }}"></button>
                <div class="species-info" data-action="filter-species">
                    <span class="species-name">
                        <span class="species-common" data-field="common-name"></span>
                        <span class="species-scientific" data-field="scientific-name"></span>
                    </span>
                </div>
                <div data-field="time"></div>
                <div data-field="confidence"></div>
                <div class="audio-status"></div>
            </div>
        </template>

        <!-- Filter indicator template -->
        <template id="filter-indicator-template">
            {{ _('Filtered') }}: <strong data-field="species-name"></strong>
            <button onclick="clearSpeciesFilter()" class="clear-filter-btn">{{ _('Clear') }}</button>
        </template>

    </div>

{% endblock %}

{% block footer_annotation %}
    <p class="annotation">
        {{ _('Confidence threshold ≥%(threshold)s', threshold=config['species_confidence_threshold']) }} ·
        {{ config['timezone'] }}
    </p>
{% endblock %}
