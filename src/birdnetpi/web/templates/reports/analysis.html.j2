{% extends "base.html.j2" %}

{% block styles %}
    {{ super() }}
    <link rel="stylesheet" href="{{ request.url_for('static', path='css/period_selector.css') }}">
    <link rel="stylesheet" href="{{ request.url_for('static', path='css/analysis.css') }}">
{% endblock %}

{% block scripts %}
    {{ super() }}
    <!-- Store period parameters for JavaScript to use -->
    <script>
    window.analysisConfig = {
        period: "{{ period }}",
        comparisonPeriod: "{{ comparison_period or 'none' }}"
    };
    </script>
    <!-- Period selector and analysis JavaScript -->
    <script src="{{ request.url_for('static', path='js/period_selector.js') }}"></script>
    <script src="{{ request.url_for('static', path='js/analysis.js') }}"></script>
{% endblock %}

{% block content %}
<!-- Period Selection Controls -->
<div class="analysis-controls">
    {% set id = 'primary-period' %}
    {% set label = _('Analysis period:') %}
    {% set initial_period = period|default('month') %}
    {% set onchange_callback = 'onPrimaryPeriodChange' %}
    {% set show_historical = true %}
    {% include 'components/period_selector.html.j2' %}

    <div class="comparison-controls" style="margin-top: 1rem;">
        <label style="font-size: 0.85rem; color: var(--color-text-secondary); margin-right: 0.5rem;">
            <input type="checkbox" id="enable-comparison" onchange="toggleComparison()" {% if comparison_period and comparison_period != 'none' %}checked{% endif %}>
            {{ _('Compare with previous period') }}
        </label>
    </div>
</div>

<!-- Analysis content container -->
<div id="analysis-loading" class="loading-indicator" style="display: none;">
    {{ _('Loading analysis data...') }}
</div>
<div id="analysis-content">
    <!-- Diversity Timeline -->
    <section class="analysis-section">
        <h2>{{ _('Diversity Timeline') }}</h2>
        <p class="section-subtitle">{{ _('Shannon diversity, Simpson index, and species richness over time') }}</p>
        <canvas id="diversity-timeline" width="800" height="300"></canvas>
    </section>

    <!-- Species Accumulation -->
    <section class="analysis-section">
        <h2>{{ _('Species Accumulation') }}</h2>
        <p class="section-subtitle">{{ _('Cumulative species discovery as detections increase') }}</p>
        <canvas id="accumulation-curve" width="800" height="300"></canvas>
    </section>

    <!-- Community Similarity -->
    <section class="analysis-section">
        <h2>{{ _('Community Similarity Matrix') }}</h2>
        <p class="section-subtitle" id="similarity-subtitle">{{ _('Jaccard similarity between time periods') }}</p>
        <div id="similarity-matrix-container" class="similarity-matrix"></div>
    </section>

    <!-- Beta Diversity -->
    <section class="analysis-section">
        <h2>{{ _('Beta Diversity (Species Turnover)') }}</h2>
        <p class="section-subtitle">{{ _('Community change between consecutive time windows') }}</p>
        <canvas id="beta-diversity" width="800" height="300"></canvas>
    </section>

    <!-- Weather Correlations -->
    <section class="analysis-section" id="weather-section">
        <h2>{{ _('Weather Correlations') }}</h2>
        <p class="section-subtitle">{{ _('Relationship between detections and weather variables') }}</p>
        <div class="weather-grid">
            <div>
                <p class="correlation-value">r = --</p>
                <canvas id="temp-correlation" width="250" height="200"></canvas>
            </div>
            <div>
                <p class="correlation-value">r = --</p>
                <canvas id="humidity-correlation" width="250" height="200"></canvas>
            </div>
            <div>
                <p class="correlation-value">r = --</p>
                <canvas id="wind-correlation" width="250" height="200"></canvas>
            </div>
        </div>
    </section>

    <!-- Activity Heatmap -->
    <section class="analysis-section">
        <h2>{{ _('Activity Heatmap') }}</h2>
        <p class="section-subtitle">{{ _('Detection patterns by day of week and hour') }}</p>
        <canvas id="activity-heatmap" width="800" height="280"></canvas>
    </section>
</div>

<!-- Footer annotation -->
<p class="annotation mt-2 pt-1 border-top" id="analysis-footer">
    {{ _('Confidence threshold: â‰¥%(threshold)s', threshold=config.species_confidence_threshold) }}
</p>

{% endblock %}
