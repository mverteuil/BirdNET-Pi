{% extends "base.html.j2" %}

{% block styles %}
    {{ super() }}
    <link rel="stylesheet" href="{{ request.url_for('static', path='css/period_selector.css') }}">
    <link rel="stylesheet" href="{{ request.url_for('static', path='css/analysis.css') }}">
{% endblock %}

{% block scripts %}
    {{ super() }}
    <!-- Plotly.js for charts -->
    <script src="{{ url_for('static', path='js/vendor/plotly.min.js') }}"></script>
    <!-- Store period parameters for JavaScript to use -->
    <script>
    window.analysisConfig = {
        period: "{{ period }}",
        comparisonPeriod: "{{ comparison_period or 'none' }}"
    };
    </script>
    <!-- Period selector and analysis JavaScript -->
    <script src="{{ url_for('static', path='js/period_selector.js') }}"></script>
    <script src="{{ url_for('static', path='js/analysis.js') }}"></script>
{% endblock %}

{% block content %}
<!-- Period Selection Controls -->
<div class="analysis-controls">
    {% set id = 'primary-period' %}
    {% set label = _('Analysis period:') %}
    {% set initial_period = period|default('month') %}
    {% set onchange_callback = 'onPrimaryPeriodChange' %}
    {% set show_historical = true %}
    {% set oldest_detection_date = oldest_detection_date %}
    {% include 'components/period_selector.html.j2' %}

    <div class="comparison-controls" style="margin-top: 1rem;">
        <label style="font-size: 0.85rem; color: var(--color-text-secondary); margin-right: 0.5rem;">
            <input type="checkbox" id="enable-comparison" onchange="toggleComparison()" {% if comparison_period and comparison_period != 'none' %}checked{% endif %}>
            {{ _('Compare with previous period') }}
        </label>
    </div>
</div>

<!-- Analysis content container -->
<div id="analysis-loading" class="loading-indicator" style="display: none;">
    {{ _('Loading analysis data...') }}
</div>
<div id="analysis-content">
    <!-- Diversity Timeline -->
    <section class="analysis-section">
        <h2>{{ _('Diversity Timeline') }}</h2>
        <p class="section-subtitle">{{ _('Shannon diversity, Simpson index, and species richness over time') }}</p>
        <p class="method-note">{{ _('Tracks community diversity metrics over time.') }} <a href="https://en.wikipedia.org/wiki/Diversity_index" target="_blank" rel="noopener">{{ _('Shannon H\'') }}</a> {{ _('measures entropy (higher = more diverse),') }} <a href="https://en.wikipedia.org/wiki/Diversity_index#Simpson_index" target="_blank" rel="noopener">{{ _('Simpson D') }}</a> {{ _('measures dominance (higher = more even),') }} <a href="https://en.wikipedia.org/wiki/Species_richness" target="_blank" rel="noopener">{{ _('Richness S') }}</a> {{ _('counts unique species.') }}</p>
        <div id="diversity-timeline" style="width: 100%; height: 300px;"></div>
    </section>

    <!-- Species Accumulation -->
    <section class="analysis-section">
        <h2>{{ _('Species Accumulation') }}</h2>
        <p class="section-subtitle">{{ _('Cumulative species discovery as detections increase') }}</p>
        <p class="method-note">{{ _('Shows how many unique species are found as more detections are recorded.') }} <a href="https://en.wikipedia.org/wiki/Species_discovery_curve" target="_blank" rel="noopener">{{ _('Species accumulation curves') }}</a> {{ _('help estimate sampling completeness and predict total diversity. Steep curves indicate high discovery rate, flattening curves suggest most species have been detected.') }}</p>
        <div id="accumulation-curve" style="width: 100%; height: 300px;"></div>
    </section>

    <!-- Community Similarity -->
    <section class="analysis-section">
        <h2>{{ _('Community Similarity Matrix') }}</h2>
        <p class="section-subtitle" id="similarity-subtitle">{{ _('Jaccard similarity between time periods') }}</p>
        <p class="method-note">{{ _('Compares species composition between time windows.') }} <a href="https://en.wikipedia.org/wiki/Jaccard_index" target="_blank" rel="noopener">{{ _('Jaccard similarity') }}</a> {{ _('measures overlap: 0% = no shared species, 100% = identical communities. High values indicate stable communities, low values show turnover or seasonal changes.') }}</p>
        <div id="similarity-matrix-container" class="similarity-matrix"></div>
    </section>

    <!-- Beta Diversity -->
    <section class="analysis-section">
        <h2>{{ _('Beta Diversity (Species Turnover)') }}</h2>
        <p class="section-subtitle">{{ _('Community change between consecutive time windows') }}</p>
        <p class="method-note">{{ _('Quantifies how much the bird community changes over time.') }} <a href="https://en.wikipedia.org/wiki/Beta_diversity" target="_blank" rel="noopener">{{ _('Beta diversity (β)') }}</a> {{ _('ranges from 0 (identical communities) to 1 (completely different). Green bars indicate stability, yellow shows moderate change, red indicates high turnover. Species gained (+) and lost (-) are shown below each bar.') }}</p>
        <div id="beta-diversity" style="width: 100%; height: 300px;"></div>
    </section>

    <!-- Weather Correlations -->
    <section class="analysis-section" id="weather-section">
        <h2>{{ _('Weather Correlations') }}</h2>
        <p class="section-subtitle">{{ _('Relationship between detections and weather variables') }}</p>
        <p class="method-note">{{ _('Explores relationships between weather and bird activity.') }} <a href="https://en.wikipedia.org/wiki/Pearson_correlation_coefficient" target="_blank" rel="noopener">{{ _('Pearson correlation (r)') }}</a> {{ _('ranges from -1 to +1. Values near 0 indicate weak correlation, ±0.3-0.7 moderate, ±0.7-1.0 strong. Positive values show variables increase together, negative values show inverse relationships.') }}</p>
        <div class="weather-grid">
            <div>
                <h3 class="chart-label">{{ _('Temperature (°C)') }}</h3>
                <p class="correlation-value">r = --</p>
                <div id="temp-correlation" style="width: 100%; height: 200px;"></div>
            </div>
            <div>
                <h3 class="chart-label">{{ _('Humidity (%)') }}</h3>
                <p class="correlation-value">r = --</p>
                <div id="humidity-correlation" style="width: 100%; height: 200px;"></div>
            </div>
            <div>
                <h3 class="chart-label">{{ _('Wind Speed (m/s)') }}</h3>
                <p class="correlation-value">r = --</p>
                <div id="wind-correlation" style="width: 100%; height: 200px;"></div>
            </div>
        </div>
    </section>

    <!-- Activity Heatmap -->
    <section class="analysis-section">
        <h2>{{ _('Activity Heatmap') }}</h2>
        <p class="section-subtitle">{{ _('Detection patterns by day of week and hour') }}</p>
        <p class="method-note">{{ _('Visualizes when birds are most active throughout the week.') }} <a href="https://en.wikipedia.org/wiki/Heat_map" target="_blank" rel="noopener">{{ _('Heat maps') }}</a> {{ _('use color intensity to show detection frequency by day and hour. Darker cells indicate higher activity, lighter cells show fewer detections. Patterns reveal daily rhythms and weekly variations in bird behavior.') }}</p>
        <div id="activity-heatmap" style="width: 100%; height: 280px;"></div>
    </section>
</div>

<!-- Footer annotation -->
<p class="annotation mt-2 pt-1 border-top" id="analysis-footer">
    {{ _('Confidence threshold: ≥%(threshold)s', threshold=config.species_confidence_threshold) }}
</p>

{% endblock %}
