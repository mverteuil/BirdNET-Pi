[supervisord]
nodaemon=true
#logfile=/dev/stderr        # Must use this exact string
logfile_maxbytes=0         # Disable rotation for stdout
loglevel=info

[unix_http_server]
file=/dev/shm/supervisor.sock  ; path to your socket file

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///dev/shm/supervisor.sock  ; use a unix:// URL for a unix socket

[program:update_migrate]
command=/opt/birdnetpi/.venv/bin/update-daemon --mode migrate
autostart=true
autorestart=false  ; One-shot, exit after completion
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0
environment=PYTHONPATH=/opt/birdnetpi/src,SERVICE_NAME=update_migrate
directory=/opt/birdnetpi
priority=1
startsecs=0
exitcodes=0        ; Exit 0 means success

[program:redis]
command=/usr/bin/redis-server /opt/birdnetpi/config_templates/redis.conf
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0
priority=50
startsecs=2

[program:caddy]
command=/usr/bin/caddy run --config /etc/caddy/Caddyfile
autostart=true
autorestart=true
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0
redirect_stderr=false

[program:fastapi]
command=sh -c 'if [ "$UVICORN_RELOAD" = "1" ]; then exec /opt/birdnetpi/.venv/bin/uvicorn birdnetpi.web.main:app --host 0.0.0.0 --port 8888 --reload --reload-dir /opt/birdnetpi/src; else exec /opt/birdnetpi/.venv/bin/uvicorn birdnetpi.web.main:app --host 0.0.0.0 --port 8888; fi'
autostart=true
autorestart=true
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0
environment=PYTHONPATH=/opt/birdnetpi/src
directory=/opt/birdnetpi

[program:pulseaudio]
command=sh -c 'if [ -z "$PULSE_SERVER" ] || [ "$PULSE_SERVER" = "unix:/run/pulse/native" ]; then exec pulseaudio --daemonize=no --exit-idle-time=-1 --log-target=stderr; else echo "Using remote PulseAudio at $PULSE_SERVER, local daemon not needed" && exit 0; fi'
autostart=true
autorestart=false
startsecs=0
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0
priority=100

[program:audio_capture]
command=/opt/birdnetpi/.venv/bin/audio-capture-daemon
autostart=true
autorestart=true
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0
environment=PYTHONPATH=/opt/birdnetpi/src,SERVICE_NAME=audio_capture
directory=/opt/birdnetpi
priority=200

[program:audio_analysis]
command=/opt/birdnetpi/.venv/bin/audio-analysis-daemon
autostart=true
autorestart=true
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0
environment=PYTHONPATH=/opt/birdnetpi/src,SERVICE_NAME=audio_analysis
directory=/opt/birdnetpi
priority=300

[program:audio_websocket]
command=/opt/birdnetpi/.venv/bin/audio-websocket-daemon
autostart=true
autorestart=true
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0
environment=PYTHONPATH=/opt/birdnetpi/src,SERVICE_NAME=audio_websocket
directory=/opt/birdnetpi
priority=300

[program:update_monitor]
command=/opt/birdnetpi/.venv/bin/update-daemon --mode monitor
autostart=true
autorestart=true
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0
environment=PYTHONPATH=/opt/birdnetpi/src,SERVICE_NAME=update_monitor
directory=/opt/birdnetpi
priority=400
